"use strict";
/**
 * CloudWatch Metrics and Monitoring Utilities
 * Provides structured logging and metrics for production monitoring
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.PerformanceTimer = void 0;
exports.logMetric = logMetric;
exports.logPerformance = logPerformance;
exports.logCircuitBreakerMetric = logCircuitBreakerMetric;
exports.logBusinessMetric = logBusinessMetric;
exports.logError = logError;
exports.logCacheMetric = logCacheMetric;
/**
 * Log structured metrics for CloudWatch
 */
function logMetric(metric) {
    const logEntry = {
        timestamp: metric.timestamp?.toISOString() || new Date().toISOString(),
        metricType: 'CUSTOM_METRIC',
        metricName: metric.metricName,
        value: metric.value,
        unit: metric.unit,
        dimensions: metric.dimensions || {},
    };
    console.log(`üìä METRIC: ${JSON.stringify(logEntry)}`);
}
/**
 * Log performance metrics
 */
function logPerformance(perf) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        metricType: 'PERFORMANCE',
        operation: perf.operation,
        duration: perf.duration,
        success: perf.success,
        errorType: perf.errorType,
        metadata: perf.metadata || {},
    };
    console.log(`‚ö° PERFORMANCE: ${JSON.stringify(logEntry)}`);
    // Also log as CloudWatch metric
    logMetric({
        metricName: `${perf.operation}_Duration`,
        value: perf.duration,
        unit: 'Milliseconds',
        dimensions: {
            Operation: perf.operation,
            Success: perf.success.toString(),
            ErrorType: perf.errorType || 'None'
        }
    });
}
/**
 * Circuit Breaker metrics
 */
function logCircuitBreakerMetric(service, state, failureCount, successCount) {
    logMetric({
        metricName: 'CircuitBreaker_State',
        value: state === 'OPEN' ? 1 : 0,
        unit: 'Count',
        dimensions: {
            Service: service,
            State: state
        }
    });
    logMetric({
        metricName: 'CircuitBreaker_FailureCount',
        value: failureCount,
        unit: 'Count',
        dimensions: {
            Service: service
        }
    });
    logMetric({
        metricName: 'CircuitBreaker_SuccessCount',
        value: successCount,
        unit: 'Count',
        dimensions: {
            Service: service
        }
    });
}
/**
 * Business metrics for Trinity
 */
function logBusinessMetric(eventType, roomId, userId, metadata) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        metricType: 'BUSINESS_EVENT',
        eventType,
        roomId: roomId || 'unknown',
        userId: userId || 'unknown',
        metadata: metadata || {},
    };
    console.log(`üíº BUSINESS: ${JSON.stringify(logEntry)}`);
    // Log as CloudWatch metric
    logMetric({
        metricName: `Business_${eventType}`,
        value: 1,
        unit: 'Count',
        dimensions: {
            EventType: eventType,
            Stage: process.env.STAGE || 'dev'
        }
    });
}
/**
 * Error tracking
 */
function logError(operation, error, context) {
    const logEntry = {
        timestamp: new Date().toISOString(),
        metricType: 'ERROR',
        operation,
        errorName: error.name,
        errorMessage: error.message,
        errorStack: error.stack,
        context: context || {},
    };
    console.error(`‚ùå ERROR: ${JSON.stringify(logEntry)}`);
    // Log as CloudWatch metric
    logMetric({
        metricName: 'Errors',
        value: 1,
        unit: 'Count',
        dimensions: {
            Operation: operation,
            ErrorType: error.name,
            Stage: process.env.STAGE || 'dev'
        }
    });
}
/**
 * Performance timer utility
 */
class PerformanceTimer {
    constructor(operation) {
        this.operation = operation;
        this.startTime = Date.now();
    }
    finish(success = true, errorType, metadata) {
        const duration = Date.now() - this.startTime;
        logPerformance({
            operation: this.operation,
            duration,
            success,
            errorType,
            metadata
        });
    }
}
exports.PerformanceTimer = PerformanceTimer;
/**
 * Cache hit/miss metrics
 */
function logCacheMetric(cacheType, hit, key) {
    logMetric({
        metricName: `Cache_${hit ? 'Hit' : 'Miss'}`,
        value: 1,
        unit: 'Count',
        dimensions: {
            CacheType: cacheType,
            Result: hit ? 'Hit' : 'Miss'
        }
    });
    if (key) {
        console.log(`üíæ CACHE_${hit ? 'HIT' : 'MISS'}: ${cacheType} - ${key}`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0cmljcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1ldHJpY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBcUJILDhCQVdDO0FBS0Qsd0NBd0JDO0FBS0QsMERBaUNDO0FBS0QsOENBMkJDO0FBS0QsNEJBNEJDO0FBOEJELHdDQWtCQztBQWxNRDs7R0FFRztBQUNILFNBQWdCLFNBQVMsQ0FBQyxNQUFrQjtJQUMxQyxNQUFNLFFBQVEsR0FBRztRQUNmLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxJQUFJLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO1FBQ3RFLFVBQVUsRUFBRSxlQUFlO1FBQzNCLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVTtRQUM3QixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7UUFDbkIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1FBQ2pCLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVSxJQUFJLEVBQUU7S0FDcEMsQ0FBQztJQUVGLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4RCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixjQUFjLENBQUMsSUFBdUI7SUFDcEQsTUFBTSxRQUFRLEdBQUc7UUFDZixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7UUFDbkMsVUFBVSxFQUFFLGFBQWE7UUFDekIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1FBQ3pCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtRQUN2QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87UUFDckIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1FBQ3pCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxJQUFJLEVBQUU7S0FDOUIsQ0FBQztJQUVGLE9BQU8sQ0FBQyxHQUFHLENB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QUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTTtTQUM3QjtLQUNGLENBQUMsQ0FBQztJQUVILElBQUksR0FBRyxFQUFFLENBQUM7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN6RSxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDbG91ZFdhdGNoIE1ldHJpY3MgYW5kIE1vbml0b3JpbmcgVXRpbGl0aWVzXHJcbiAqIFByb3ZpZGVzIHN0cnVjdHVyZWQgbG9nZ2luZyBhbmQgbWV0cmljcyBmb3IgcHJvZHVjdGlvbiBtb25pdG9yaW5nXHJcbiAqL1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBNZXRyaWNEYXRhIHtcclxuICBtZXRyaWNOYW1lOiBzdHJpbmc7XHJcbiAgdmFsdWU6IG51bWJlcjtcclxuICB1bml0OiAnQ291bnQnIHwgJ1NlY29uZHMnIHwgJ01pbGxpc2Vjb25kcycgfCAnUGVyY2VudCcgfCAnQnl0ZXMnO1xyXG4gIGRpbWVuc2lvbnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xyXG4gIHRpbWVzdGFtcD86IERhdGU7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUGVyZm9ybWFuY2VNZXRyaWMge1xyXG4gIG9wZXJhdGlvbjogc3RyaW5nO1xyXG4gIGR1cmF0aW9uOiBudW1iZXI7XHJcbiAgc3VjY2VzczogYm9vbGVhbjtcclxuICBlcnJvclR5cGU/OiBzdHJpbmc7XHJcbiAgbWV0YWRhdGE/OiB7IFtrZXk6IHN0cmluZ106IGFueSB9O1xyXG59XHJcblxyXG4vKipcclxuICogTG9nIHN0cnVjdHVyZWQgbWV0cmljcyBmb3IgQ2xvdWRXYXRjaFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGxvZ01ldHJpYyhtZXRyaWM6IE1ldHJpY0RhdGEpOiB2b2lkIHtcclxuICBjb25zdCBsb2dFbnRyeSA9IHtcclxuICAgIHRpbWVzdGFtcDogbWV0cmljLnRpbWVzdGFtcD8udG9JU09TdHJpbmcoKSB8fCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICBtZXRyaWNUeXBlOiAnQ1VTVE9NX01FVFJJQycsXHJcbiAgICBtZXRyaWNOYW1lOiBtZXRyaWMubWV0cmljTmFtZSxcclxuICAgIHZhbHVlOiBtZXRyaWMudmFsdWUsXHJcbiAgICB1bml0OiBtZXRyaWMudW5pdCxcclxuICAgIGRpbWVuc2lvbnM6IG1ldHJpYy5kaW1lbnNpb25zIHx8IHt9LFxyXG4gIH07XHJcblxyXG4gIGNvbnNvbGUubG9nKGDwn5OKIE1FVFJJQzogJHtKU09OLnN0cmluZ2lmeShsb2dFbnRyeSl9YCk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMb2cgcGVyZm9ybWFuY2UgbWV0cmljc1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGxvZ1BlcmZvcm1hbmNlKHBlcmY6IFBlcmZvcm1hbmNlTWV0cmljKTogdm9pZCB7XHJcbiAgY29uc3QgbG9nRW50cnkgPSB7XHJcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgIG1ldHJpY1R5cGU6ICdQRVJGT1JNQU5DRScsXHJcbiAgICBvcGVyYXRpb246IHBlcmYub3BlcmF0aW9uLFxyXG4gICAgZHVyYXRpb246IHBlcmYuZHVyYXRpb24sXHJcbiAgICBzdWNjZXNzOiBwZXJmLnN1Y2Nlc3MsXHJcbiAgICBlcnJvclR5cGU6IHBlcmYuZXJyb3JUeXBlLFxyXG4gICAgbWV0YWRhdGE6IHBlcmYubWV0YWRhdGEgfHwge30sXHJcbiAgfTtcclxuXHJcbiAgY29uc29sZS5sb2coYOKaoSBQRVJGT1JNQU5DRTogJHtKU09OLnN0cmluZ2lmeShsb2dFbnRyeSl9YCk7XHJcblxyXG4gIC8vIEFsc28gbG9nIGFzIENsb3VkV2F0Y2ggbWV0cmljXHJcbiAgbG9nTWV0cmljKHtcclxuICAgIG1ldHJpY05hbWU6IGAke3BlcmYub3BlcmF0aW9ufV9EdXJhdGlvbmAsXHJcbiAgICB2YWx1ZTogcGVyZi5kdXJhdGlvbixcclxuICAgIHVuaXQ6ICdNaWxsaXNlY29uZHMnLFxyXG4gICAgZGltZW5zaW9uczoge1xyXG4gICAgICBPcGVyYXRpb246IHBlcmYub3BlcmF0aW9uLFxyXG4gICAgICBTdWNjZXNzOiBwZXJmLnN1Y2Nlc3MudG9TdHJpbmcoKSxcclxuICAgICAgRXJyb3JUeXBlOiBwZXJmLmVycm9yVHlwZSB8fCAnTm9uZSdcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIENpcmN1aXQgQnJlYWtlciBtZXRyaWNzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gbG9nQ2lyY3VpdEJyZWFrZXJNZXRyaWMoXHJcbiAgc2VydmljZTogc3RyaW5nLFxyXG4gIHN0YXRlOiBzdHJpbmcsXHJcbiAgZmFpbHVyZUNvdW50OiBudW1iZXIsXHJcbiAgc3VjY2Vzc0NvdW50OiBudW1iZXJcclxuKTogdm9pZCB7XHJcbiAgbG9nTWV0cmljKHtcclxuICAgIG1ldHJpY05hbWU6ICdDaXJjdWl0QnJlYWtlcl9TdGF0ZScsXHJcbiAgICB2YWx1ZTogc3RhdGUgPT09ICdPUEVOJyA/IDEgOiAwLFxyXG4gICAgdW5pdDogJ0NvdW50JyxcclxuICAgIGRpbWVuc2lvbnM6IHtcclxuICAgICAgU2VydmljZTogc2VydmljZSxcclxuICAgICAgU3RhdGU6IHN0YXRlXHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGxvZ01ldHJpYyh7XHJcbiAgICBtZXRyaWNOYW1lOiAnQ2lyY3VpdEJyZWFrZXJfRmFpbHVyZUNvdW50JyxcclxuICAgIHZhbHVlOiBmYWlsdXJlQ291bnQsXHJcbiAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgZGltZW5zaW9uczoge1xyXG4gICAgICBTZXJ2aWNlOiBzZXJ2aWNlXHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIGxvZ01ldHJpYyh7XHJcbiAgICBtZXRyaWNOYW1lOiAnQ2lyY3VpdEJyZWFrZXJfU3VjY2Vzc0NvdW50JyxcclxuICAgIHZhbHVlOiBzdWNjZXNzQ291bnQsXHJcbiAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgZGltZW5zaW9uczoge1xyXG4gICAgICBTZXJ2aWNlOiBzZXJ2aWNlXHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBCdXNpbmVzcyBtZXRyaWNzIGZvciBUcmluaXR5XHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gbG9nQnVzaW5lc3NNZXRyaWMoXHJcbiAgZXZlbnRUeXBlOiAnUk9PTV9DUkVBVEVEJyB8ICdST09NX0pPSU5FRCcgfCAnUk9PTV9KT0lORURfQllfSU5WSVRFJyB8ICdWT1RFX0NBU1QnIHwgJ01BVENIX0ZPVU5EJyB8ICdBSV9SRUNPTU1FTkRBVElPTicgfCAnTU9WSUVTX0NBQ0hFRCcgfCAnSU5WSVRFX0xJTktfQ1JFQVRFRCcgfCAnV0VCX0lOVklURV9WQUxJREFURUQnIHwgJ1VTRVJfRElTQ09OTkVDVEVEJyB8ICdST09NX1NUQVRFX1NZTkNFRCcgfCAnQ09OTkVDVElPTl9DTEVBTkVEX1VQJyB8ICdDT05ORUNUSU9OX0hBTkRMRUQnIHwgJ0RJU0NPTk5FQ1RJT05fSEFORExFRCcgfCAnU1RBVEVfU1lOQ19SRVFVRVNURUQnIHwgJ0NPTk5FQ1RJT05fU1RBVFVTX0NIRUNLRUQnLFxyXG4gIHJvb21JZD86IHN0cmluZyxcclxuICB1c2VySWQ/OiBzdHJpbmcsXHJcbiAgbWV0YWRhdGE/OiB7IFtrZXk6IHN0cmluZ106IGFueSB9XHJcbik6IHZvaWQge1xyXG4gIGNvbnN0IGxvZ0VudHJ5ID0ge1xyXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICBtZXRyaWNUeXBlOiAnQlVTSU5FU1NfRVZFTlQnLFxyXG4gICAgZXZlbnRUeXBlLFxyXG4gICAgcm9vbUlkOiByb29tSWQgfHwgJ3Vua25vd24nLFxyXG4gICAgdXNlcklkOiB1c2VySWQgfHwgJ3Vua25vd24nLFxyXG4gICAgbWV0YWRhdGE6IG1ldGFkYXRhIHx8IHt9LFxyXG4gIH07XHJcblxyXG4gIGNvbnNvbGUubG9nKGDwn5K8IEJVU0lORVNTOiAke0pTT04uc3RyaW5naWZ5KGxvZ0VudHJ5KX1gKTtcclxuXHJcbiAgLy8gTG9nIGFzIENsb3VkV2F0Y2ggbWV0cmljXHJcbiAgbG9nTWV0cmljKHtcclxuICAgIG1ldHJpY05hbWU6IGBCdXNpbmVzc18ke2V2ZW50VHlwZX1gLFxyXG4gICAgdmFsdWU6IDEsXHJcbiAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgZGltZW5zaW9uczoge1xyXG4gICAgICBFdmVudFR5cGU6IGV2ZW50VHlwZSxcclxuICAgICAgU3RhZ2U6IHByb2Nlc3MuZW52LlNUQUdFIHx8ICdkZXYnXHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBFcnJvciB0cmFja2luZ1xyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGxvZ0Vycm9yKFxyXG4gIG9wZXJhdGlvbjogc3RyaW5nLFxyXG4gIGVycm9yOiBFcnJvcixcclxuICBjb250ZXh0PzogeyBba2V5OiBzdHJpbmddOiBhbnkgfVxyXG4pOiB2b2lkIHtcclxuICBjb25zdCBsb2dFbnRyeSA9IHtcclxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgbWV0cmljVHlwZTogJ0VSUk9SJyxcclxuICAgIG9wZXJhdGlvbixcclxuICAgIGVycm9yTmFtZTogZXJyb3IubmFtZSxcclxuICAgIGVycm9yTWVzc2FnZTogZXJyb3IubWVzc2FnZSxcclxuICAgIGVycm9yU3RhY2s6IGVycm9yLnN0YWNrLFxyXG4gICAgY29udGV4dDogY29udGV4dCB8fCB7fSxcclxuICB9O1xyXG5cclxuICBjb25zb2xlLmVycm9yKGDinYwgRVJST1I6ICR7SlNPTi5zdHJpbmdpZnkobG9nRW50cnkpfWApO1xyXG5cclxuICAvLyBMb2cgYXMgQ2xvdWRXYXRjaCBtZXRyaWNcclxuICBsb2dNZXRyaWMoe1xyXG4gICAgbWV0cmljTmFtZTogJ0Vycm9ycycsXHJcbiAgICB2YWx1ZTogMSxcclxuICAgIHVuaXQ6ICdDb3VudCcsXHJcbiAgICBkaW1lbnNpb25zOiB7XHJcbiAgICAgIE9wZXJhdGlvbjogb3BlcmF0aW9uLFxyXG4gICAgICBFcnJvclR5cGU6IGVycm9yLm5hbWUsXHJcbiAgICAgIFN0YWdlOiBwcm9jZXNzLmVudi5TVEFHRSB8fCAnZGV2J1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcblxyXG4vKipcclxuICogUGVyZm9ybWFuY2UgdGltZXIgdXRpbGl0eVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFBlcmZvcm1hbmNlVGltZXIge1xyXG4gIHByaXZhdGUgc3RhcnRUaW1lOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBvcGVyYXRpb246IHN0cmluZztcclxuXHJcbiAgY29uc3RydWN0b3Iob3BlcmF0aW9uOiBzdHJpbmcpIHtcclxuICAgIHRoaXMub3BlcmF0aW9uID0gb3BlcmF0aW9uO1xyXG4gICAgdGhpcy5zdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gIH1cclxuXHJcbiAgZmluaXNoKHN1Y2Nlc3M6IGJvb2xlYW4gPSB0cnVlLCBlcnJvclR5cGU/OiBzdHJpbmcsIG1ldGFkYXRhPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfSk6IHZvaWQge1xyXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWU7XHJcbiAgICBcclxuICAgIGxvZ1BlcmZvcm1hbmNlKHtcclxuICAgICAgb3BlcmF0aW9uOiB0aGlzLm9wZXJhdGlvbixcclxuICAgICAgZHVyYXRpb24sXHJcbiAgICAgIHN1Y2Nlc3MsXHJcbiAgICAgIGVycm9yVHlwZSxcclxuICAgICAgbWV0YWRhdGFcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIENhY2hlIGhpdC9taXNzIG1ldHJpY3NcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2dDYWNoZU1ldHJpYyhcclxuICBjYWNoZVR5cGU6ICdNT1ZJRVMnIHwgJ1VTRVJfUFJPRklMRScgfCAnUk9PTV9EQVRBJyxcclxuICBoaXQ6IGJvb2xlYW4sXHJcbiAga2V5Pzogc3RyaW5nXHJcbik6IHZvaWQge1xyXG4gIGxvZ01ldHJpYyh7XHJcbiAgICBtZXRyaWNOYW1lOiBgQ2FjaGVfJHtoaXQgPyAnSGl0JyA6ICdNaXNzJ31gLFxyXG4gICAgdmFsdWU6IDEsXHJcbiAgICB1bml0OiAnQ291bnQnLFxyXG4gICAgZGltZW5zaW9uczoge1xyXG4gICAgICBDYWNoZVR5cGU6IGNhY2hlVHlwZSxcclxuICAgICAgUmVzdWx0OiBoaXQgPyAnSGl0JyA6ICdNaXNzJ1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBpZiAoa2V5KSB7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+SviBDQUNIRV8ke2hpdCA/ICdISVQnIDogJ01JU1MnfTogJHtjYWNoZVR5cGV9IC0gJHtrZXl9YCk7XHJcbiAgfVxyXG59Il19