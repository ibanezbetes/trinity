#!/usr/bin/env node\n\n/**\n * Setup APK Signing Configuration for Trinity Mobile\n * This script helps setup keystore and signing configuration for production builds\n */\n\nconst { execSync } = require('child_process');\nconst fs = require('fs');\nconst path = require('path');\nconst readline = require('readline');\n\nclass SigningSetup {\n  constructor() {\n    this.keystoreDir = path.join('android', 'app');\n    this.keystorePath = path.join(this.keystoreDir, 'trinity-release.keystore');\n    this.signingConfigPath = path.join('android', 'signing.properties');\n    \n    console.log('ðŸ” Setting up APK signing configuration...');\n  }\n\n  async promptUser(question) {\n    const rl = readline.createInterface({\n      input: process.stdin,\n      output: process.stdout\n    });\n    \n    return new Promise(resolve => {\n      rl.question(question, answer => {\n        rl.close();\n        resolve(answer.trim());\n      });\n    });\n  }\n\n  async generateKeystore() {\n    console.log('ðŸ”‘ Generating release keystore...');\n    \n    // Check if keystore already exists\n    if (fs.existsSync(this.keystorePath)) {\n      const overwrite = await this.promptUser('Keystore already exists. Overwrite? (y/N): ');\n      if (overwrite.toLowerCase() !== 'y') {\n        console.log('âœ… Using existing keystore');\n        return;\n      }\n    }\n    \n    // Collect keystore information\n    console.log('\\nðŸ“ Please provide keystore information:');\n    \n    const keystoreInfo = {\n      alias: await this.promptUser('Key alias (default: trinity-key): ') || 'trinity-key',\n      password: await this.promptUser('Keystore password: '),\n      keyPassword: await this.promptUser('Key password (press enter to use same as keystore): '),\n      dname: {\n        cn: await this.promptUser('Your name (CN): '),\n        ou: await this.promptUser('Organizational unit (OU, default: Development): ') || 'Development',\n        o: await this.promptUser('Organization (O, default: Trinity): ') || 'Trinity',\n        l: await this.promptUser('City (L): '),\n        st: await this.promptUser('State/Province (ST): '),\n        c: await this.promptUser('Country code (C, e.g., US, ES): ')\n      }\n    };\n    \n    // Use keystore password for key if not specified\n    if (!keystoreInfo.keyPassword) {\n      keystoreInfo.keyPassword = keystoreInfo.password;\n    }\n    \n    // Build DN string\n    const dnParts = [];\n    if (keystoreInfo.dname.cn) dnParts.push(`CN=${keystoreInfo.dname.cn}`);\n    if (keystoreInfo.dname.ou) dnParts.push(`OU=${keystoreInfo.dname.ou}`);\n    if (keystoreInfo.dname.o) dnParts.push(`O=${keystoreInfo.dname.o}`);\n    if (keystoreInfo.dname.l) dnParts.push(`L=${keystoreInfo.dname.l}`);\n    if (keystoreInfo.dname.st) dnParts.push(`ST=${keystoreInfo.dname.st}`);\n    if (keystoreInfo.dname.c) dnParts.push(`C=${keystoreInfo.dname.c}`);\n    \n    const dn = dnParts.join(', ');\n    \n    // Generate keystore using keytool\n    const keytoolCommand = [\n      'keytool -genkeypair',\n      '-v',\n      `-keystore \"${this.keystorePath}\"`,\n      `-alias ${keystoreInfo.alias}`,\n      `-keyalg RSA`,\n      `-keysize 2048`,\n      `-validity 10000`,\n      `-storepass ${keystoreInfo.password}`,\n      `-keypass ${keystoreInfo.keyPassword}`,\n      `-dname \"${dn}\"`\n    ].join(' ');\n    \n    try {\n      console.log('\\nðŸ”¨ Generating keystore...');\n      execSync(keytoolCommand, { stdio: 'inherit' });\n      console.log('âœ… Keystore generated successfully');\n      \n      // Save signing configuration\n      await this.saveSigningConfig(keystoreInfo);\n      \n    } catch (error) {\n      console.error('âŒ Failed to generate keystore:', error.message);\n      throw error;\n    }\n  }\n\n  async saveSigningConfig(keystoreInfo) {\n    console.log('ðŸ’¾ Saving signing configuration...');\n    \n    const signingConfig = [\n      '# Trinity APK Signing Configuration',\n      '# This file contains sensitive information - do not commit to version control',\n      '',\n      `TRINITY_RELEASE_STORE_FILE=trinity-release.keystore`,\n      `TRINITY_RELEASE_KEY_ALIAS=${keystoreInfo.alias}`,\n      `TRINITY_RELEASE_STORE_PASSWORD=${keystoreInfo.password}`,\n      `TRINITY_RELEASE_KEY_PASSWORD=${keystoreInfo.keyPassword}`,\n      '',\n      '# Keystore location (relative to android/app directory)',\n      `TRINITY_KEYSTORE_PATH=${path.relative(path.join('android', 'app'), this.keystorePath)}`,\n    ].join('\\n');\n    \n    fs.writeFileSync(this.signingConfigPath, signingConfig);\n    console.log(`âœ… Signing configuration saved: ${this.signingConfigPath}`);\n    \n    // Update .gitignore to exclude signing files\n    this.updateGitignore();\n  }\n\n  updateGitignore() {\n    console.log('ðŸ“ Updating .gitignore...');\n    \n    const gitignorePath = path.join('.gitignore');\n    const signingEntries = [\n      '',\n      '# APK Signing (sensitive)',\n      'android/signing.properties',\n      'android/app/*.keystore',\n      'android/app/*.jks',\n    ];\n    \n    let gitignoreContent = '';\n    if (fs.existsSync(gitignorePath)) {\n      gitignoreContent = fs.readFileSync(gitignorePath, 'utf8');\n    }\n    \n    // Check if signing entries already exist\n    if (!gitignoreContent.includes('android/signing.properties')) {\n      gitignoreContent += signingEntries.join('\\n') + '\\n';\n      fs.writeFileSync(gitignorePath, gitignoreContent);\n      console.log('âœ… .gitignore updated');\n    } else {\n      console.log('âœ… .gitignore already contains signing entries');\n    }\n  }\n\n  updateBuildGradle() {\n    console.log('âš™ï¸ Updating build.gradle for signing...');\n    \n    const buildGradlePath = path.join('android', 'app', 'build.gradle');\n    \n    if (!fs.existsSync(buildGradlePath)) {\n      console.error('âŒ build.gradle not found');\n      return;\n    }\n    \n    let buildGradleContent = fs.readFileSync(buildGradlePath, 'utf8');\n    \n    // Check if signing config already exists\n    if (buildGradleContent.includes('TRINITY_RELEASE_STORE_FILE')) {\n      console.log('âœ… build.gradle already configured for signing');\n      return;\n    }\n    \n    // Add signing configuration\n    const signingConfigBlock = `\n    // Load signing configuration\n    def signingPropsFile = rootProject.file(\"signing.properties\")\n    def signingProps = new Properties()\n    if (signingPropsFile.exists()) {\n        signingProps.load(new FileInputStream(signingPropsFile))\n    }\n`;\n    \n    const signingConfigsBlock = `        release {\n            if (signingPropsFile.exists()) {\n                storeFile file(signingProps['TRINITY_RELEASE_STORE_FILE'])\n                storePassword signingProps['TRINITY_RELEASE_STORE_PASSWORD']\n                keyAlias signingProps['TRINITY_RELEASE_KEY_ALIAS']\n                keyPassword signingProps['TRINITY_RELEASE_KEY_PASSWORD']\n            } else {\n                // Fallback to debug keystore if signing.properties not found\n                storeFile file('debug.keystore')\n                storePassword 'android'\n                keyAlias 'androiddebugkey'\n                keyPassword 'android'\n            }\n        }`;\n    \n    // Insert signing configuration after android block starts\n    buildGradleContent = buildGradleContent.replace(\n      /android\\s*\\{/,\n      `android {${signingConfigBlock}`\n    );\n    \n    // Update release signing config\n    buildGradleContent = buildGradleContent.replace(\n      /release\\s*\\{[^}]*signingConfig\\s+signingConfigs\\.debug[^}]*\\}/,\n      signingConfigsBlock\n    );\n    \n    fs.writeFileSync(buildGradlePath, buildGradleContent);\n    console.log('âœ… build.gradle updated for release signing');\n  }\n\n  verifyKeystore() {\n    console.log('ðŸ” Verifying keystore...');\n    \n    if (!fs.existsSync(this.keystorePath)) {\n      console.error('âŒ Keystore not found');\n      return false;\n    }\n    \n    if (!fs.existsSync(this.signingConfigPath)) {\n      console.error('âŒ Signing configuration not found');\n      return false;\n    }\n    \n    try {\n      // Read signing config to get alias\n      const signingConfig = fs.readFileSync(this.signingConfigPath, 'utf8');\n      const aliasMatch = signingConfig.match(/TRINITY_RELEASE_KEY_ALIAS=(.+)/);\n      const passwordMatch = signingConfig.match(/TRINITY_RELEASE_STORE_PASSWORD=(.+)/);\n      \n      if (!aliasMatch || !passwordMatch) {\n        console.error('âŒ Invalid signing configuration');\n        return false;\n      }\n      \n      const alias = aliasMatch[1].trim();\n      const password = passwordMatch[1].trim();\n      \n      // List keystore contents\n      const listCommand = `keytool -list -v -keystore \"${this.keystorePath}\" -alias ${alias} -storepass ${password}`;\n      execSync(listCommand, { stdio: 'pipe' });\n      \n      console.log('âœ… Keystore verification successful');\n      return true;\n      \n    } catch (error) {\n      console.error('âŒ Keystore verification failed:', error.message);\n      return false;\n    }\n  }\n\n  async setup() {\n    try {\n      console.log('ðŸš€ Setting up APK signing for Trinity...\\n');\n      \n      // Check if Java/keytool is available\n      try {\n        execSync('keytool -help', { stdio: 'ignore' });\n      } catch (error) {\n        throw new Error('keytool not found. Please ensure Java JDK is installed and in PATH.');\n      }\n      \n      await this.generateKeystore();\n      this.updateBuildGradle();\n      \n      console.log('\\nðŸ” Verifying setup...');\n      const isValid = this.verifyKeystore();\n      \n      if (isValid) {\n        console.log('\\nðŸŽ‰ APK signing setup completed successfully!');\n        console.log('\\nðŸ“‹ Important notes:');\n        console.log('   1. Keep your keystore file safe - you cannot recover it if lost');\n        console.log('   2. The signing.properties file contains sensitive information');\n        console.log('   3. Never commit keystore or signing.properties to version control');\n        console.log('   4. Use the same keystore for all future releases');\n        console.log('\\nðŸ”¨ To build signed APK:');\n        console.log('   npm run build:apk:production');\n      } else {\n        console.log('\\nâš ï¸ Signing setup completed with errors.');\n        console.log('   Please check the configuration and try again.');\n      }\n      \n      return isValid;\n      \n    } catch (error) {\n      console.error('âŒ Failed to setup APK signing:', error.message);\n      throw error;\n    }\n  }\n}\n\n// CLI interface\nif (require.main === module) {\n  const setup = new SigningSetup();\n  setup.setup().catch(() => process.exit(1));\n}\n\nmodule.exports = SigningSetup;\n"