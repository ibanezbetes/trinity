#!/usr/bin/env node\n\n/**\n * Setup Reproducible Build Environment for Trinity Mobile\n * This script ensures consistent build environment across different machines\n */\n\nconst { execSync } = require('child_process');\nconst fs = require('fs');\nconst path = require('path');\nconst os = require('os');\n\nclass BuildEnvironmentSetup {\n  constructor() {\n    this.config = this.loadBuildConfig();\n    this.platform = process.platform;\n    console.log('ðŸ”§ Setting up reproducible build environment...');\n  }\n\n  loadBuildConfig() {\n    const configPath = path.join(__dirname, '..', '.buildrc');\n    const config = {};\n    \n    if (fs.existsSync(configPath)) {\n      const content = fs.readFileSync(configPath, 'utf8');\n      content.split('\\n').forEach(line => {\n        line = line.trim();\n        if (line && !line.startsWith('#')) {\n          const [key, value] = line.split('=');\n          if (key && value) {\n            config[key.trim()] = value.trim();\n          }\n        }\n      });\n    }\n    \n    return config;\n  }\n\n  checkNodeVersion() {\n    console.log('ðŸ“¦ Checking Node.js version...');\n    \n    const currentVersion = process.version.substring(1); // Remove 'v' prefix\n    const requiredVersion = this.config.NODE_VERSION;\n    \n    if (requiredVersion && currentVersion !== requiredVersion) {\n      console.warn(`âš ï¸ Node.js version mismatch:`);\n      console.warn(`   Current: ${currentVersion}`);\n      console.warn(`   Required: ${requiredVersion}`);\n      console.warn(`   Consider using nvm: nvm use ${requiredVersion}`);\n    } else {\n      console.log(`âœ… Node.js version: ${currentVersion}`);\n    }\n  }\n\n  checkJavaVersion() {\n    console.log('â˜• Checking Java version...');\n    \n    try {\n      const javaVersion = execSync('java -version 2>&1', { encoding: 'utf8' });\n      const versionMatch = javaVersion.match(/version \"(\\d+)/);\n      \n      if (versionMatch) {\n        const majorVersion = parseInt(versionMatch[1]);\n        const requiredVersion = parseInt(this.config.JAVA_VERSION || '17');\n        \n        if (majorVersion !== requiredVersion) {\n          console.warn(`âš ï¸ Java version mismatch:`);\n          console.warn(`   Current: ${majorVersion}`);\n          console.warn(`   Required: ${requiredVersion}`);\n        } else {\n          console.log(`âœ… Java version: ${majorVersion}`);\n        }\n      }\n    } catch (error) {\n      console.error('âŒ Java not found or not accessible');\n      console.error('   Please install Java 17 and ensure it\\'s in your PATH');\n    }\n  }\n\n  checkAndroidSDK() {\n    console.log('ðŸ¤– Checking Android SDK...');\n    \n    const androidHome = process.env.ANDROID_HOME || process.env.ANDROID_SDK_ROOT;\n    \n    if (!androidHome) {\n      console.error('âŒ ANDROID_HOME not set');\n      console.error('   Please set ANDROID_HOME environment variable');\n      return false;\n    }\n    \n    if (!fs.existsSync(androidHome)) {\n      console.error(`âŒ Android SDK not found at: ${androidHome}`);\n      return false;\n    }\n    \n    console.log(`âœ… Android SDK: ${androidHome}`);\n    \n    // Check for required SDK components\n    const platformsDir = path.join(androidHome, 'platforms');\n    const buildToolsDir = path.join(androidHome, 'build-tools');\n    \n    if (fs.existsSync(platformsDir)) {\n      const platforms = fs.readdirSync(platformsDir);\n      console.log(`ðŸ“± Available platforms: ${platforms.join(', ')}`);\n    }\n    \n    if (fs.existsSync(buildToolsDir)) {\n      const buildTools = fs.readdirSync(buildToolsDir);\n      console.log(`ðŸ”¨ Available build tools: ${buildTools.join(', ')}`);\n    }\n    \n    return true;\n  }\n\n  setupGradleProperties() {\n    console.log('âš™ï¸ Setting up Gradle properties...');\n    \n    const gradlePropsPath = path.join('android', 'gradle.properties');\n    const properties = [];\n    \n    // Read existing properties\n    if (fs.existsSync(gradlePropsPath)) {\n      const existing = fs.readFileSync(gradlePropsPath, 'utf8');\n      properties.push(existing);\n    }\n    \n    // Add reproducible build properties\n    const buildProperties = [\n      '',\n      '# Reproducible Build Configuration',\n      `android.compileSdkVersion=${this.config.ANDROID_COMPILE_SDK || '34'}`,\n      `android.buildToolsVersion=${this.config.ANDROID_BUILD_TOOLS || '34.0.0'}`,\n      `android.minSdkVersion=${this.config.ANDROID_MIN_SDK || '21'}`,\n      `android.targetSdkVersion=${this.config.ANDROID_TARGET_SDK || '34'}`,\n      '',\n      '# Build Optimization',\n      `android.enableMinifyInReleaseBuilds=${this.config.ENABLE_MINIFY_RELEASE || 'true'}`,\n      `android.enableShrinkResourcesInReleaseBuilds=${this.config.ENABLE_SHRINK_RESOURCES || 'true'}`,\n      `android.enablePngCrunchInReleaseBuilds=${this.config.ENABLE_PNG_CRUNCH || 'true'}`,\n      '',\n      '# Performance',\n      'org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=512m',\n      'org.gradle.parallel=true',\n      'org.gradle.configureondemand=true',\n      'org.gradle.daemon=true',\n      '',\n      '# React Native',\n      `hermesEnabled=${this.config.HERMES_ENABLED || 'true'}`,\n      'enableHermes=true',\n      '',\n      '# Reproducible builds',\n      'android.injected.testOnly=false',\n      'android.injected.build.api=34',\n    ];\n    \n    properties.push(buildProperties.join('\\n'));\n    \n    fs.writeFileSync(gradlePropsPath, properties.join('\\n'));\n    console.log('âœ… Gradle properties configured');\n  }\n\n  setupLocalProperties() {\n    console.log('ðŸ“ Setting up local.properties...');\n    \n    const localPropsPath = path.join('android', 'local.properties');\n    const androidHome = process.env.ANDROID_HOME || process.env.ANDROID_SDK_ROOT;\n    \n    if (androidHome) {\n      let sdkDir = androidHome;\n      \n      // Convert Windows paths for Gradle\n      if (this.platform === 'win32') {\n        sdkDir = sdkDir.replace(/\\\\/g, '/');\n      }\n      \n      const content = [\n        '# Auto-generated local.properties',\n        `sdk.dir=${sdkDir}`,\n        '',\n        '# NDK (if needed)',\n        '# ndk.dir=/path/to/ndk',\n      ].join('\\n');\n      \n      fs.writeFileSync(localPropsPath, content);\n      console.log('âœ… local.properties configured');\n    } else {\n      console.warn('âš ï¸ ANDROID_HOME not set, skipping local.properties');\n    }\n  }\n\n  createBuildOutputDirectory() {\n    console.log('ðŸ“ Setting up build output directory...');\n    \n    const outputDir = this.config.BUILD_OUTPUT_DIR || './build-output';\n    \n    if (!fs.existsSync(outputDir)) {\n      fs.mkdirSync(outputDir, { recursive: true });\n      console.log(`âœ… Created build output directory: ${outputDir}`);\n    } else {\n      console.log(`âœ… Build output directory exists: ${outputDir}`);\n    }\n    \n    // Create subdirectories\n    const subdirs = ['apk', 'logs', 'reports'];\n    subdirs.forEach(subdir => {\n      const subdirPath = path.join(outputDir, subdir);\n      if (!fs.existsSync(subdirPath)) {\n        fs.mkdirSync(subdirPath, { recursive: true });\n      }\n    });\n  }\n\n  generateBuildInfo() {\n    console.log('ðŸ“‹ Generating build info...');\n    \n    const buildInfo = {\n      timestamp: new Date().toISOString(),\n      platform: this.platform,\n      arch: os.arch(),\n      nodeVersion: process.version,\n      npmVersion: this.getNpmVersion(),\n      environment: this.config.BUILD_ENVIRONMENT || 'production',\n      config: this.config,\n      systemInfo: {\n        os: os.type(),\n        release: os.release(),\n        cpus: os.cpus().length,\n        memory: Math.round(os.totalmem() / 1024 / 1024 / 1024) + 'GB'\n      }\n    };\n    \n    const outputDir = this.config.BUILD_OUTPUT_DIR || './build-output';\n    const buildInfoPath = path.join(outputDir, 'build-info.json');\n    \n    fs.writeFileSync(buildInfoPath, JSON.stringify(buildInfo, null, 2));\n    console.log(`âœ… Build info saved: ${buildInfoPath}`);\n  }\n\n  getNpmVersion() {\n    try {\n      return execSync('npm --version', { encoding: 'utf8' }).trim();\n    } catch (error) {\n      return 'unknown';\n    }\n  }\n\n  validateEnvironment() {\n    console.log('ðŸ” Validating build environment...');\n    \n    const checks = [\n      { name: 'Node.js', check: () => !!process.version },\n      { name: 'npm', check: () => {\n        try {\n          execSync('npm --version', { stdio: 'ignore' });\n          return true;\n        } catch { return false; }\n      }},\n      { name: 'Java', check: () => {\n        try {\n          execSync('java -version', { stdio: 'ignore' });\n          return true;\n        } catch { return false; }\n      }},\n      { name: 'Android SDK', check: () => !!(process.env.ANDROID_HOME || process.env.ANDROID_SDK_ROOT) },\n      { name: 'Gradle Wrapper', check: () => {\n        const gradlewPath = path.join('android', this.platform === 'win32' ? 'gradlew.bat' : 'gradlew');\n        return fs.existsSync(gradlewPath);\n      }}\n    ];\n    \n    let allPassed = true;\n    \n    checks.forEach(({ name, check }) => {\n      const passed = check();\n      console.log(`${passed ? 'âœ…' : 'âŒ'} ${name}`);\n      if (!passed) allPassed = false;\n    });\n    \n    if (allPassed) {\n      console.log('ðŸŽ‰ All environment checks passed!');\n    } else {\n      console.warn('âš ï¸ Some environment checks failed. Build may not work correctly.');\n    }\n    \n    return allPassed;\n  }\n\n  setup() {\n    try {\n      console.log('ðŸš€ Setting up Trinity mobile build environment...\\n');\n      \n      this.checkNodeVersion();\n      this.checkJavaVersion();\n      this.checkAndroidSDK();\n      this.setupGradleProperties();\n      this.setupLocalProperties();\n      this.createBuildOutputDirectory();\n      this.generateBuildInfo();\n      \n      console.log('\\nðŸ” Final validation...');\n      const isValid = this.validateEnvironment();\n      \n      if (isValid) {\n        console.log('\\nðŸŽ‰ Build environment setup completed successfully!');\n        console.log('\\nðŸ“‹ Next steps:');\n        console.log('   1. Run: npm run build:apk:production');\n        console.log('   2. Or: npm run build:apk:development');\n      } else {\n        console.log('\\nâš ï¸ Build environment setup completed with warnings.');\n        console.log('   Please address the failed checks before building.');\n      }\n      \n      return isValid;\n      \n    } catch (error) {\n      console.error('âŒ Failed to setup build environment:', error.message);\n      throw error;\n    }\n  }\n}\n\n// CLI interface\nif (require.main === module) {\n  const setup = new BuildEnvironmentSetup();\n  setup.setup().catch(() => process.exit(1));\n}\n\nmodule.exports = BuildEnvironmentSetup;\n"