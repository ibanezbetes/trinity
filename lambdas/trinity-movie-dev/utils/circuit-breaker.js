"use strict";
/**
 * Circuit Breaker Implementation for External API Calls
 * Prevents cascading failures when external services are down
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.tmdbCircuitBreaker = exports.CircuitBreaker = exports.CircuitState = void 0;
const metrics_1 = require("./metrics");
var CircuitState;
(function (CircuitState) {
    CircuitState["CLOSED"] = "CLOSED";
    CircuitState["OPEN"] = "OPEN";
    CircuitState["HALF_OPEN"] = "HALF_OPEN"; // Testing if service is back
})(CircuitState || (exports.CircuitState = CircuitState = {}));
class CircuitBreaker {
    constructor(config = {}) {
        this.config = {
            failureThreshold: 5,
            resetTimeout: 60000, // 1 minute
            monitoringPeriod: 300000, // 5 minutes
            successThreshold: 2,
            serviceName: 'UnknownService',
            ...config
        };
        this.state = {
            state: CircuitState.CLOSED,
            failureCount: 0,
            lastFailureTime: 0,
            successCount: 0,
            nextAttempt: 0
        };
        // Log initial state
        this.logCurrentState();
    }
    async execute(operation) {
        const timer = new metrics_1.PerformanceTimer(`CircuitBreaker_${this.config.serviceName}`);
        const now = Date.now();
        // Check if we should transition states
        this.updateState(now);
        // If circuit is open, fail fast
        if (this.state.state === CircuitState.OPEN) {
            const error = new Error(`Circuit breaker is OPEN for ${this.config.serviceName}. Next attempt at ${new Date(this.state.nextAttempt).toISOString()}`);
            timer.finish(false, 'CircuitOpen');
            throw error;
        }
        try {
            const result = await operation();
            this.onSuccess();
            timer.finish(true, undefined, { state: this.state.state });
            return result;
        }
        catch (error) {
            this.onFailure(now);
            timer.finish(false, 'OperationFailed', {
                state: this.state.state,
                failureCount: this.state.failureCount
            });
            (0, metrics_1.logError)(`CircuitBreaker_${this.config.serviceName}`, error, {
                circuitState: this.state.state,
                failureCount: this.state.failureCount
            });
            throw error;
        }
    }
    updateState(now) {
        const previousState = this.state.state;
        switch (this.state.state) {
            case CircuitState.CLOSED:
                // Reset failure count if monitoring period has passed
                if (now - this.state.lastFailureTime > this.config.monitoringPeriod) {
                    this.state.failureCount = 0;
                }
                break;
            case CircuitState.OPEN:
                // Check if we should transition to half-open
                if (now >= this.state.nextAttempt) {
                    this.state.state = CircuitState.HALF_OPEN;
                    this.state.successCount = 0;
                    console.log(`ðŸ”„ Circuit breaker for ${this.config.serviceName} transitioning to HALF_OPEN`);
                }
                break;
            case CircuitState.HALF_OPEN:
                // Stay in half-open, will be handled by success/failure
                break;
        }
        // Log state change
        if (previousState !== this.state.state) {
            this.logCurrentState();
        }
    }
    onSuccess() {
        const previousState = this.state.state;
        switch (this.state.state) {
            case CircuitState.CLOSED:
                // Reset failure count on success
                this.state.failureCount = 0;
                break;
            case CircuitState.HALF_OPEN:
                this.state.successCount++;
                if (this.state.successCount >= this.config.successThreshold) {
                    this.state.state = CircuitState.CLOSED;
                    this.state.failureCount = 0;
                    this.state.successCount = 0;
                    console.log(`âœ… Circuit breaker for ${this.config.serviceName} CLOSED - service recovered`);
                }
                break;
        }
        if (previousState !== this.state.state) {
            this.logCurrentState();
        }
    }
    onFailure(now) {
        const previousState = this.state.state;
        this.state.lastFailureTime = now;
        switch (this.state.state) {
            case CircuitState.CLOSED:
                this.state.failureCount++;
                if (this.state.failureCount >= this.config.failureThreshold) {
                    this.state.state = CircuitState.OPEN;
                    this.state.nextAttempt = now + this.config.resetTimeout;
                    console.log(`ðŸš¨ Circuit breaker for ${this.config.serviceName} OPENED - too many failures (${this.state.failureCount})`);
                }
                break;
            case CircuitState.HALF_OPEN:
                // Go back to open on any failure
                this.state.state = CircuitState.OPEN;
                this.state.nextAttempt = now + this.config.resetTimeout;
                this.state.successCount = 0;
                console.log(`ðŸš¨ Circuit breaker for ${this.config.serviceName} back to OPEN - half-open test failed`);
                break;
        }
        if (previousState !== this.state.state) {
            this.logCurrentState();
        }
    }
    logCurrentState() {
        (0, metrics_1.logCircuitBreakerMetric)(this.config.serviceName, this.state.state, this.state.failureCount, this.state.successCount);
    }
    getState() {
        return { ...this.state };
    }
    getConfig() {
        return { ...this.config };
    }
    // Manual controls for testing/admin
    forceOpen() {
        this.state.state = CircuitState.OPEN;
        this.state.nextAttempt = Date.now() + this.config.resetTimeout;
        console.log(`ðŸ”§ Circuit breaker for ${this.config.serviceName} manually OPENED`);
        this.logCurrentState();
    }
    forceClose() {
        this.state.state = CircuitState.CLOSED;
        this.state.failureCount = 0;
        this.state.successCount = 0;
        console.log(`ðŸ”§ Circuit breaker for ${this.config.serviceName} manually CLOSED`);
        this.logCurrentState();
    }
}
exports.CircuitBreaker = CircuitBreaker;
// Singleton instance for TMDB API
exports.tmdbCircuitBreaker = new CircuitBreaker({
    failureThreshold: parseInt(process.env.CIRCUIT_BREAKER_FAILURE_THRESHOLD || '5'),
    resetTimeout: parseInt(process.env.CIRCUIT_BREAKER_TIMEOUT_MS || '60000'),
    monitoringPeriod: 300000, // 5 minutes
    successThreshold: 2,
    serviceName: 'TMDB_API'
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2lyY3VpdC1icmVha2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2lyY3VpdC1icmVha2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQUVILHVDQUFnRjtBQUVoRixJQUFZLFlBSVg7QUFKRCxXQUFZLFlBQVk7SUFDdEIsaUNBQWlCLENBQUE7SUFDakIsNkJBQWEsQ0FBQTtJQUNiLHVDQUF1QixDQUFBLENBQUMsNkJBQTZCO0FBQ3ZELENBQUMsRUFKVyxZQUFZLDRCQUFaLFlBQVksUUFJdkI7QUFrQkQsTUFBYSxjQUFjO0lBSXpCLFlBQVksU0FBd0MsRUFBRTtRQUNwRCxJQUFJLENBQUMsTUFBTSxHQUFHO1lBQ1osZ0JBQWdCLEVBQUUsQ0FBQztZQUNuQixZQUFZLEVBQUUsS0FBSyxFQUFFLFdBQVc7WUFDaEMsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLFlBQVk7WUFDdEMsZ0JBQWdCLEVBQUUsQ0FBQztZQUNuQixXQUFXLEVBQUUsZ0JBQWdCO1lBQzdCLEdBQUcsTUFBTTtTQUNWLENBQUM7UUFFRixJQUFJLENBQUMsS0FBSyxHQUFHO1lBQ1gsS0FBSyxFQUFFLFlBQVksQ0FBQyxNQUFNO1lBQzFCLFlBQVksRUFBRSxDQUFDO1lBQ2YsZUFBZSxFQUFFLENBQUM7WUFDbEIsWUFBWSxFQUFFLENBQUM7WUFDZixXQUFXLEVBQUUsQ0FBQztTQUNmLENBQUM7UUFFRixvQkFBb0I7UUFDcEIsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFJLFNBQTJCO1FBQzFDLE1BQU0sS0FBSyxHQUFHLElBQUksMEJBQWdCLENBQUMsa0JBQWtCLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNoRixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFdkIsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FB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QUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsSUFBSSxPQUFPLENBQUM7SUFDekUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLFlBQVk7SUFDdEMsZ0JBQWdCLEVBQUUsQ0FBQztJQUNuQixXQUFXLEVBQUUsVUFBVTtDQUN4QixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ2lyY3VpdCBCcmVha2VyIEltcGxlbWVudGF0aW9uIGZvciBFeHRlcm5hbCBBUEkgQ2FsbHNcclxuICogUHJldmVudHMgY2FzY2FkaW5nIGZhaWx1cmVzIHdoZW4gZXh0ZXJuYWwgc2VydmljZXMgYXJlIGRvd25cclxuICovXHJcblxyXG5pbXBvcnQgeyBsb2dDaXJjdWl0QnJlYWtlck1ldHJpYywgbG9nRXJyb3IsIFBlcmZvcm1hbmNlVGltZXIgfSBmcm9tICcuL21ldHJpY3MnO1xyXG5cclxuZXhwb3J0IGVudW0gQ2lyY3VpdFN0YXRlIHtcclxuICBDTE9TRUQgPSAnQ0xPU0VEJywgICAgIC8vIE5vcm1hbCBvcGVyYXRpb25cclxuICBPUEVOID0gJ09QRU4nLCAgICAgICAgIC8vIENpcmN1aXQgaXMgb3BlbiwgZmFpbGluZyBmYXN0XHJcbiAgSEFMRl9PUEVOID0gJ0hBTEZfT1BFTicgLy8gVGVzdGluZyBpZiBzZXJ2aWNlIGlzIGJhY2tcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDaXJjdWl0QnJlYWtlckNvbmZpZyB7XHJcbiAgZmFpbHVyZVRocmVzaG9sZDogbnVtYmVyOyAgICAvLyBOdW1iZXIgb2YgZmFpbHVyZXMgYmVmb3JlIG9wZW5pbmdcclxuICByZXNldFRpbWVvdXQ6IG51bWJlcjsgICAgICAgIC8vIFRpbWUgdG8gd2FpdCBiZWZvcmUgdHJ5aW5nIGFnYWluIChtcylcclxuICBtb25pdG9yaW5nUGVyaW9kOiBudW1iZXI7ICAgIC8vIFRpbWUgd2luZG93IGZvciBmYWlsdXJlIGNvdW50aW5nIChtcylcclxuICBzdWNjZXNzVGhyZXNob2xkOiBudW1iZXI7ICAgIC8vIFN1Y2Nlc3NlcyBuZWVkZWQgdG8gY2xvc2UgZnJvbSBoYWxmLW9wZW5cclxuICBzZXJ2aWNlTmFtZTogc3RyaW5nOyAgICAgICAgIC8vIFNlcnZpY2UgbmFtZSBmb3IgbWV0cmljc1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENpcmN1aXRCcmVha2VyU3RhdGUge1xyXG4gIHN0YXRlOiBDaXJjdWl0U3RhdGU7XHJcbiAgZmFpbHVyZUNvdW50OiBudW1iZXI7XHJcbiAgbGFzdEZhaWx1cmVUaW1lOiBudW1iZXI7XHJcbiAgc3VjY2Vzc0NvdW50OiBudW1iZXI7XHJcbiAgbmV4dEF0dGVtcHQ6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIENpcmN1aXRCcmVha2VyIHtcclxuICBwcml2YXRlIHN0YXRlOiBDaXJjdWl0QnJlYWtlclN0YXRlO1xyXG4gIHByaXZhdGUgY29uZmlnOiBDaXJjdWl0QnJlYWtlckNvbmZpZztcclxuXHJcbiAgY29uc3RydWN0b3IoY29uZmlnOiBQYXJ0aWFsPENpcmN1aXRCcmVha2VyQ29uZmlnPiA9IHt9KSB7XHJcbiAgICB0aGlzLmNvbmZpZyA9IHtcclxuICAgICAgZmFpbHVyZVRocmVzaG9sZDogNSxcclxuICAgICAgcmVzZXRUaW1lb3V0OiA2MDAwMCwgLy8gMSBtaW51dGVcclxuICAgICAgbW9uaXRvcmluZ1BlcmlvZDogMzAwMDAwLCAvLyA1IG1pbnV0ZXNcclxuICAgICAgc3VjY2Vzc1RocmVzaG9sZDogMixcclxuICAgICAgc2VydmljZU5hbWU6ICdVbmtub3duU2VydmljZScsXHJcbiAgICAgIC4uLmNvbmZpZ1xyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICBzdGF0ZTogQ2lyY3VpdFN0YXRlLkNMT1NFRCxcclxuICAgICAgZmFpbHVyZUNvdW50OiAwLFxyXG4gICAgICBsYXN0RmFpbHVyZVRpbWU6IDAsXHJcbiAgICAgIHN1Y2Nlc3NDb3VudDogMCxcclxuICAgICAgbmV4dEF0dGVtcHQ6IDBcclxuICAgIH07XHJcblxyXG4gICAgLy8gTG9nIGluaXRpYWwgc3RhdGVcclxuICAgIHRoaXMubG9nQ3VycmVudFN0YXRlKCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBleGVjdXRlPFQ+KG9wZXJhdGlvbjogKCkgPT4gUHJvbWlzZTxUPik6IFByb21pc2U8VD4ge1xyXG4gICAgY29uc3QgdGltZXIgPSBuZXcgUGVyZm9ybWFuY2VUaW1lcihgQ2lyY3VpdEJyZWFrZXJfJHt0aGlzLmNvbmZpZy5zZXJ2aWNlTmFtZX1gKTtcclxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XHJcblxyXG4gICAgLy8gQ2hlY2sgaWYgd2Ugc2hvdWxkIHRyYW5zaXRpb24gc3RhdGVzXHJcbiAgICB0aGlzLnVwZGF0ZVN0YXRlKG5vdyk7XHJcblxyXG4gICAgLy8gSWYgY2lyY3VpdCBpcyBvcGVuLCBmYWlsIGZhc3RcclxuICAgIGlmICh0aGlzLnN0YXRlLnN0YXRlID09PSBDaXJjdWl0U3RhdGUuT1BFTikge1xyXG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihgQ2lyY3VpdCBicmVha2VyIGlzIE9QRU4gZm9yICR7dGhpcy5jb25maWcuc2VydmljZU5hbWV9LiBOZXh0IGF0dGVtcHQgYXQgJHtuZXcgRGF0ZSh0aGlzLnN0YXRlLm5leHRBdHRlbXB0KS50b0lTT1N0cmluZygpfWApO1xyXG4gICAgICB0aW1lci5maW5pc2goZmFsc2UsICdDaXJjdWl0T3BlbicpO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBvcGVyYXRpb24oKTtcclxuICAgICAgdGhpcy5vblN1Y2Nlc3MoKTtcclxuICAgICAgdGltZXIuZmluaXNoKHRydWUsIHVuZGVmaW5lZCwgeyBzdGF0ZTogdGhpcy5zdGF0ZS5zdGF0ZSB9KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHRoaXMub25GYWlsdXJlKG5vdyk7XHJcbiAgICAgIHRpbWVyLmZpbmlzaChmYWxzZSwgJ09wZXJhdGlvbkZhaWxlZCcsIHsgXHJcbiAgICAgICAgc3RhdGU6IHRoaXMuc3RhdGUuc3RhdGUsXHJcbiAgICAgICAgZmFpbHVyZUNvdW50OiB0aGlzLnN0YXRlLmZhaWx1cmVDb3VudCBcclxuICAgICAgfSk7XHJcbiAgICAgIFxyXG4gICAgICBsb2dFcnJvcihgQ2lyY3VpdEJyZWFrZXJfJHt0aGlzLmNvbmZpZy5zZXJ2aWNlTmFtZX1gLCBlcnJvciBhcyBFcnJvciwge1xyXG4gICAgICAgIGNpcmN1aXRTdGF0ZTogdGhpcy5zdGF0ZS5zdGF0ZSxcclxuICAgICAgICBmYWlsdXJlQ291bnQ6IHRoaXMuc3RhdGUuZmFpbHVyZUNvdW50XHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZVN0YXRlKG5vdzogbnVtYmVyKTogdm9pZCB7XHJcbiAgICBjb25zdCBwcmV2aW91c1N0YXRlID0gdGhpcy5zdGF0ZS5zdGF0ZTtcclxuICAgIFxyXG4gICAgc3dpdGNoICh0aGlzLnN0YXRlLnN0YXRlKSB7XHJcbiAgICAgIGNhc2UgQ2lyY3VpdFN0YXRlLkNMT1NFRDpcclxuICAgICAgICAvLyBSZXNldCBmYWlsdXJlIGNvdW50IGlmIG1vbml0b3JpbmcgcGVyaW9kIGhhcyBwYXNzZWRcclxuICAgICAgICBpZiAobm93IC0gdGhpcy5zdGF0ZS5sYXN0RmFpbHVyZVRpbWUgPiB0aGlzLmNvbmZpZy5tb25pdG9yaW5nUGVyaW9kKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlLmZhaWx1cmVDb3VudCA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgY2FzZSBDaXJjdWl0U3RhdGUuT1BFTjpcclxuICAgICAgICAvLyBDaGVjayBpZiB3ZSBzaG91bGQgdHJhbnNpdGlvbiB0byBoYWxmLW9wZW5cclxuICAgICAgICBpZiAobm93ID49IHRoaXMuc3RhdGUubmV4dEF0dGVtcHQpIHtcclxuICAgICAgICAgIHRoaXMuc3RhdGUuc3RhdGUgPSBDaXJjdWl0U3RhdGUuSEFMRl9PUEVOO1xyXG4gICAgICAgICAgdGhpcy5zdGF0ZS5zdWNjZXNzQ291bnQgPSAwO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYPCflIQgQ2lyY3VpdCBicmVha2VyIGZvciAke3RoaXMuY29uZmlnLnNlcnZpY2VOYW1lfSB0cmFuc2l0aW9uaW5nIHRvIEhBTEZfT1BFTmApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuXHJcbiAgICAgIGNhc2UgQ2lyY3VpdFN0YXRlLkhBTEZfT1BFTjpcclxuICAgICAgICAvLyBTdGF5IGluIGhhbGYtb3Blbiwgd2lsbCBiZSBoYW5kbGVkIGJ5IHN1Y2Nlc3MvZmFpbHVyZVxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIExvZyBzdGF0ZSBjaGFuZ2VcclxuICAgIGlmIChwcmV2aW91c1N0YXRlICE9PSB0aGlzLnN0YXRlLnN0YXRlKSB7XHJcbiAgICAgIHRoaXMubG9nQ3VycmVudFN0YXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uU3VjY2VzcygpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByZXZpb3VzU3RhdGUgPSB0aGlzLnN0YXRlLnN0YXRlO1xyXG4gICAgXHJcbiAgICBzd2l0Y2ggKHRoaXMuc3RhdGUuc3RhdGUpIHtcclxuICAgICAgY2FzZSBDaXJjdWl0U3RhdGUuQ0xPU0VEOlxyXG4gICAgICAgIC8vIFJlc2V0IGZhaWx1cmUgY291bnQgb24gc3VjY2Vzc1xyXG4gICAgICAgIHRoaXMuc3RhdGUuZmFpbHVyZUNvdW50ID0gMDtcclxuICAgICAgICBicmVhaztcclxuXHJcbiAgICAgIGNhc2UgQ2lyY3VpdFN0YXRlLkhBTEZfT1BFTjpcclxuICAgICAgICB0aGlzLnN0YXRlLnN1Y2Nlc3NDb3VudCsrO1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLnN1Y2Nlc3NDb3VudCA+PSB0aGlzLmNvbmZpZy5zdWNjZXNzVGhyZXNob2xkKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlLnN0YXRlID0gQ2lyY3VpdFN0YXRlLkNMT1NFRDtcclxuICAgICAgICAgIHRoaXMuc3RhdGUuZmFpbHVyZUNvdW50ID0gMDtcclxuICAgICAgICAgIHRoaXMuc3RhdGUuc3VjY2Vzc0NvdW50ID0gMDtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKGDinIUgQ2lyY3VpdCBicmVha2VyIGZvciAke3RoaXMuY29uZmlnLnNlcnZpY2VOYW1lfSBDTE9TRUQgLSBzZXJ2aWNlIHJlY292ZXJlZGApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuICAgIH1cclxuXHJcbiAgICBpZiAocHJldmlvdXNTdGF0ZSAhPT0gdGhpcy5zdGF0ZS5zdGF0ZSkge1xyXG4gICAgICB0aGlzLmxvZ0N1cnJlbnRTdGF0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbkZhaWx1cmUobm93OiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByZXZpb3VzU3RhdGUgPSB0aGlzLnN0YXRlLnN0YXRlO1xyXG4gICAgdGhpcy5zdGF0ZS5sYXN0RmFpbHVyZVRpbWUgPSBub3c7XHJcblxyXG4gICAgc3dpdGNoICh0aGlzLnN0YXRlLnN0YXRlKSB7XHJcbiAgICAgIGNhc2UgQ2lyY3VpdFN0YXRlLkNMT1NFRDpcclxuICAgICAgICB0aGlzLnN0YXRlLmZhaWx1cmVDb3VudCsrO1xyXG4gICAgICAgIGlmICh0aGlzLnN0YXRlLmZhaWx1cmVDb3VudCA+PSB0aGlzLmNvbmZpZy5mYWlsdXJlVGhyZXNob2xkKSB7XHJcbiAgICAgICAgICB0aGlzLnN0YXRlLnN0YXRlID0gQ2lyY3VpdFN0YXRlLk9QRU47XHJcbiAgICAgICAgICB0aGlzLnN0YXRlLm5leHRBdHRlbXB0ID0gbm93ICsgdGhpcy5jb25maWcucmVzZXRUaW1lb3V0O1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYPCfmqggQ2lyY3VpdCBicmVha2VyIGZvciAke3RoaXMuY29uZmlnLnNlcnZpY2VOYW1lfSBPUEVORUQgLSB0b28gbWFueSBmYWlsdXJlcyAoJHt0aGlzLnN0YXRlLmZhaWx1cmVDb3VudH0pYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgY2FzZSBDaXJjdWl0U3RhdGUuSEFMRl9PUEVOOlxyXG4gICAgICAgIC8vIEdvIGJhY2sgdG8gb3BlbiBvbiBhbnkgZmFpbHVyZVxyXG4gICAgICAgIHRoaXMuc3RhdGUuc3RhdGUgPSBDaXJjdWl0U3RhdGUuT1BFTjtcclxuICAgICAgICB0aGlzLnN0YXRlLm5leHRBdHRlbXB0ID0gbm93ICsgdGhpcy5jb25maWcucmVzZXRUaW1lb3V0O1xyXG4gICAgICAgIHRoaXMuc3RhdGUuc3VjY2Vzc0NvdW50ID0gMDtcclxuICAgICAgICBjb25zb2xlLmxvZyhg8J+aqCBDaXJjdWl0IGJyZWFrZXIgZm9yICR7dGhpcy5jb25maWcuc2VydmljZU5hbWV9IGJhY2sgdG8gT1BFTiAtIGhhbGYtb3BlbiB0ZXN0IGZhaWxlZGApO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChwcmV2aW91c1N0YXRlICE9PSB0aGlzLnN0YXRlLnN0YXRlKSB7XHJcbiAgICAgIHRoaXMubG9nQ3VycmVudFN0YXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxvZ0N1cnJlbnRTdGF0ZSgpOiB2b2lkIHtcclxuICAgIGxvZ0NpcmN1aXRCcmVha2VyTWV0cmljKFxyXG4gICAgICB0aGlzLmNvbmZpZy5zZXJ2aWNlTmFtZSxcclxuICAgICAgdGhpcy5zdGF0ZS5zdGF0ZSxcclxuICAgICAgdGhpcy5zdGF0ZS5mYWlsdXJlQ291bnQsXHJcbiAgICAgIHRoaXMuc3RhdGUuc3VjY2Vzc0NvdW50XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0U3RhdGUoKTogQ2lyY3VpdEJyZWFrZXJTdGF0ZSB7XHJcbiAgICByZXR1cm4geyAuLi50aGlzLnN0YXRlIH07XHJcbiAgfVxyXG5cclxuICBnZXRDb25maWcoKTogQ2lyY3VpdEJyZWFrZXJDb25maWcge1xyXG4gICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcclxuICB9XHJcblxyXG4gIC8vIE1hbnVhbCBjb250cm9scyBmb3IgdGVzdGluZy9hZG1pblxyXG4gIGZvcmNlT3BlbigpOiB2b2lkIHtcclxuICAgIHRoaXMuc3RhdGUuc3RhdGUgPSBDaXJjdWl0U3RhdGUuT1BFTjtcclxuICAgIHRoaXMuc3RhdGUubmV4dEF0dGVtcHQgPSBEYXRlLm5vdygpICsgdGhpcy5jb25maWcucmVzZXRUaW1lb3V0O1xyXG4gICAgY29uc29sZS5sb2coYPCflKcgQ2lyY3VpdCBicmVha2VyIGZvciAke3RoaXMuY29uZmlnLnNlcnZpY2VOYW1lfSBtYW51YWxseSBPUEVORURgKTtcclxuICAgIHRoaXMubG9nQ3VycmVudFN0YXRlKCk7XHJcbiAgfVxyXG5cclxuICBmb3JjZUNsb3NlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zdGF0ZS5zdGF0ZSA9IENpcmN1aXRTdGF0ZS5DTE9TRUQ7XHJcbiAgICB0aGlzLnN0YXRlLmZhaWx1cmVDb3VudCA9IDA7XHJcbiAgICB0aGlzLnN0YXRlLnN1Y2Nlc3NDb3VudCA9IDA7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+UpyBDaXJjdWl0IGJyZWFrZXIgZm9yICR7dGhpcy5jb25maWcuc2VydmljZU5hbWV9IG1hbnVhbGx5IENMT1NFRGApO1xyXG4gICAgdGhpcy5sb2dDdXJyZW50U3RhdGUoKTtcclxuICB9XHJcbn1cclxuXHJcbi8vIFNpbmdsZXRvbiBpbnN0YW5jZSBmb3IgVE1EQiBBUElcclxuZXhwb3J0IGNvbnN0IHRtZGJDaXJjdWl0QnJlYWtlciA9IG5ldyBDaXJjdWl0QnJlYWtlcih7XHJcbiAgZmFpbHVyZVRocmVzaG9sZDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0lSQ1VJVF9CUkVBS0VSX0ZBSUxVUkVfVEhSRVNIT0xEIHx8ICc1JyksXHJcbiAgcmVzZXRUaW1lb3V0OiBwYXJzZUludChwcm9jZXNzLmVudi5DSVJDVUlUX0JSRUFLRVJfVElNRU9VVF9NUyB8fCAnNjAwMDAnKSxcclxuICBtb25pdG9yaW5nUGVyaW9kOiAzMDAwMDAsIC8vIDUgbWludXRlc1xyXG4gIHN1Y2Nlc3NUaHJlc2hvbGQ6IDIsXHJcbiAgc2VydmljZU5hbWU6ICdUTURCX0FQSSdcclxufSk7Il19