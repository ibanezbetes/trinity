"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
/**
 * RealtimeHandler: AppSync Subscriptions
 * Maneja la publicaci√≥n de eventos en tiempo real para subscriptions
 */
const handler = async (event) => {
    console.log('üì° Realtime Handler:', JSON.stringify(event, null, 2));
    const fieldName = event.info?.fieldName;
    const args = event.arguments;
    const { sub: userId } = event.identity; // Usuario autenticado
    try {
        switch (fieldName) {
            case 'publishRoomEvent':
                return await publishRoomEvent(userId, args.roomId, args.eventType, args.data);
            case 'publishVoteEvent':
                return await publishVoteEvent(userId, args.roomId, args.voteData);
            case 'publishMatchEvent':
                return await publishMatchEvent(userId, args.roomId, args.matchData);
            case 'publishMemberEvent':
                return await publishMemberEvent(userId, args.roomId, args.memberData);
            case 'publishRoleEvent':
                return await publishRoleEvent(userId, args.roomId, args.roleData);
            case 'publishModerationEvent':
                return await publishModerationEvent(userId, args.roomId, args.moderationData);
            case 'publishScheduleEvent':
                return await publishScheduleEvent(userId, args.roomId, args.scheduleData);
            case 'publishThemeEvent':
                return await publishThemeEvent(userId, args.roomId, args.themeData);
            case 'publishSettingsEvent':
                return await publishSettingsEvent(userId, args.roomId, args.settingsData);
            case 'publishChatEvent':
                return await publishChatEvent(userId, args.roomId, args.chatData);
            case 'publishSuggestionEvent':
                return await publishSuggestionEvent(userId, args.roomId, args.suggestionData);
            default:
                throw new Error(`Operaci√≥n no soportada: ${fieldName}`);
        }
    }
    catch (error) {
        console.error(`‚ùå Error en ${fieldName}:`, error);
        throw error;
    }
};
exports.handler = handler;
/**
 * Validar que el usuario tiene acceso a la sala
 */
async function validateRoomAccess(userId, roomId) {
    try {
        const response = await docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: process.env.ROOM_MEMBERS_TABLE,
            Key: { roomId, userId },
        }));
        return response.Item?.isActive === true;
    }
    catch (error) {
        console.warn('‚ö†Ô∏è Error validando acceso a sala:', error);
        return false;
    }
}
/**
 * Publicar evento general de sala
 */
async function publishRoomEvent(userId, roomId, eventType, data) {
    // Validar acceso
    const hasAccess = await validateRoomAccess(userId, roomId);
    if (!hasAccess) {
        throw new Error('Usuario no tiene acceso a esta sala');
    }
    const event = {
        id: `room_${roomId}_${Date.now()}`,
        timestamp: new Date().toISOString(),
        roomId,
        eventType,
        data: typeof data === 'string' ? data : JSON.stringify(data),
    };
    console.log(`üì° Publishing room event: ${eventType} for room ${roomId}`);
    return event;
}
/**
 * Publicar evento de voto
 */
async function publishVoteEvent(userId, roomId, voteData) {
    const hasAccess = await validateRoomAccess(userId, roomId);
    if (!hasAccess) {
        throw new Error('Usuario no tiene acceso a esta sala');
    }
    const parsedData = typeof voteData === 'string' ? JSON.parse(voteData) : voteData;
    const event = {
        id: `vote_${roomId}_${userId}_${Date.now()}`,
        timestamp: new Date().toISOString(),
        roomId,
        eventType: 'VOTE_UPDATE',
        userId,
        mediaId: parsedData.mediaId,
        voteType: parsedData.voteType || 'LIKE',
        progress: parsedData.progress || {
            totalVotes: 0,
            likesCount: 0,
            dislikesCount: 0,
            skipsCount: 0,
            remainingUsers: 0,
            percentage: 0
        }
    };
    console.log(`üó≥Ô∏è Publishing vote event for room ${roomId}, user ${userId}`);
    return event;
}
/**
 * Publicar evento de match encontrado
 */
async function publishMatchEvent(userId, roomId, matchData) {
    const hasAccess = await validateRoomAccess(userId, roomId);
    if (!hasAccess) {
        throw new Error('Usuario no tiene acceso a esta sala');
    }
    const parsedData = typeof matchData === 'string' ? JSON.parse(matchData) : matchData;
    const event = {
        id: `match_${roomId}_${Date.now()}`,
        timestamp: new Date().toISOString(),
        roomId,
        eventType: 'MATCH_FOUND',
        matchId: parsedData.matchId || `match_${roomId}_${parsedData.mediaId}`,
        mediaId: parsedData.mediaId,
        mediaTitle: parsedData.mediaTitle || 'Unknown Movie',
        participants: parsedData.participants || [],
        consensusType: parsedData.consensusType || 'UNANIMOUS'
    };
    console.log(`üéâ Publishing match event for room ${roomId}: ${parsedData.mediaTitle}`);
    return event;
}
/**
 * Publicar evento de miembro
 */
async function publishMemberEvent(userId, roomId, memberData) {
    const hasAccess = await validateRoomAccess(userId, roomId);
    if (!hasAccess) {
        throw new Error('Usuario no tiene acceso a esta sala');
    }
    const parsedData = typeof memberData === 'string' ? JSON.parse(memberData) : memberData;
    const event = {
        id: `member_${roomId}_${userId}_${Date.now()}`,
        timestamp: new Date().toISOString(),
        roomId,
        eventType: 'MEMBER_UPDATE',
        userId: parsedData.userId || userId,
        action: parsedData.action || 'JOINED',
        memberCount: parsedData.memberCount || 1,
        memberData: parsedData.memberData || null
    };
    console.log(`üë• Publishing member event for room ${roomId}: ${parsedData.action}`);
    return event;
}
/**
 * Publicar eventos de caracter√≠sticas avanzadas (stubs para futuro)
 */
async function publishRoleEvent(userId, roomId, roleData) {
    console.log(`üëë Role event (future feature): ${roomId}`);
    return { id: `role_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'ROLE_UPDATE' };
}
async function publishModerationEvent(userId, roomId, moderationData) {
    console.log(`üõ°Ô∏è Moderation event (future feature): ${roomId}`);
    return { id: `mod_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'MODERATION_ACTION' };
}
async function publishScheduleEvent(userId, roomId, scheduleData) {
    console.log(`üìÖ Schedule event (future feature): ${roomId}`);
    return { id: `schedule_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'SCHEDULE_UPDATE' };
}
async function publishThemeEvent(userId, roomId, themeData) {
    console.log(`üé® Theme event (future feature): ${roomId}`);
    return { id: `theme_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'THEME_CHANGE' };
}
async function publishSettingsEvent(userId, roomId, settingsData) {
    console.log(`‚öôÔ∏è Settings event (future feature): ${roomId}`);
    return { id: `settings_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'SETTINGS_CHANGE' };
}
async function publishChatEvent(userId, roomId, chatData) {
    console.log(`üí¨ Chat event (future feature): ${roomId}`);
    return { id: `chat_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'CHAT_MESSAGE' };
}
async function publishSuggestionEvent(userId, roomId, suggestionData) {
    console.log(`üí° Suggestion event (future feature): ${roomId}`);
    return { id: `suggestion_${Date.now()}`, timestamp: new Date().toISOString(), roomId, eventType: 'CONTENT_SUGGESTION' };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbHRpbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWFsdGltZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTJFO0FBRTNFLE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFNUQ7OztHQUdHO0FBQ0ksTUFBTSxPQUFPLEdBQXFDLEtBQUssRUFBRSxLQUFnQyxFQUFFLEVBQUU7SUFDbEcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVwRSxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQztJQUN4QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO0lBQzdCLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLFFBQWUsQ0FBQyxDQUFDLHNCQUFzQjtJQUVyRSxJQUFJLENBQUM7UUFDSCxRQUFRLFNBQVMsRUFBRSxDQUFDO1lBQ2xCLEtBQUssa0JBQWtCO2dCQUNyQixPQUFPLE1BQU0sZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFaEYsS0FBSyxrQkFBa0I7Z0JBQ3JCLE9BQU8sTUFBTSxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFcEUsS0FBSyxtQkFBbUI7Z0JBQ3RCLE9BQU8sTUFBTSxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFB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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwU3luY1Jlc29sdmVyRXZlbnQsIEFwcFN5bmNSZXNvbHZlckhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcclxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBHZXRDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcclxuXHJcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XHJcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xyXG5cclxuLyoqXHJcbiAqIFJlYWx0aW1lSGFuZGxlcjogQXBwU3luYyBTdWJzY3JpcHRpb25zXHJcbiAqIE1hbmVqYSBsYSBwdWJsaWNhY2nDs24gZGUgZXZlbnRvcyBlbiB0aWVtcG8gcmVhbCBwYXJhIHN1YnNjcmlwdGlvbnNcclxuICovXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBBcHBTeW5jUmVzb2x2ZXJIYW5kbGVyPGFueSwgYW55PiA9IGFzeW5jIChldmVudDogQXBwU3luY1Jlc29sdmVyRXZlbnQ8YW55PikgPT4ge1xyXG4gIGNvbnNvbGUubG9nKCfwn5OhIFJlYWx0aW1lIEhhbmRsZXI6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcclxuXHJcbiAgY29uc3QgZmllbGROYW1lID0gZXZlbnQuaW5mbz8uZmllbGROYW1lO1xyXG4gIGNvbnN0IGFyZ3MgPSBldmVudC5hcmd1bWVudHM7XHJcbiAgY29uc3QgeyBzdWI6IHVzZXJJZCB9ID0gZXZlbnQuaWRlbnRpdHkgYXMgYW55OyAvLyBVc3VhcmlvIGF1dGVudGljYWRvXHJcblxyXG4gIHRyeSB7XHJcbiAgICBzd2l0Y2ggKGZpZWxkTmFtZSkge1xyXG4gICAgICBjYXNlICdwdWJsaXNoUm9vbUV2ZW50JzpcclxuICAgICAgICByZXR1cm4gYXdhaXQgcHVibGlzaFJvb21FdmVudCh1c2VySWQsIGFyZ3Mucm9vbUlkLCBhcmdzLmV2ZW50VHlwZSwgYXJncy5kYXRhKTtcclxuICAgICAgXHJcbiAgICAgIGNhc2UgJ3B1Ymxpc2hWb3RlRXZlbnQnOlxyXG4gICAgICAgIHJldHVybiBhd2FpdCBwdWJsaXNoVm90ZUV2ZW50KHVzZXJJZCwgYXJncy5yb29tSWQsIGFyZ3Mudm90ZURhdGEpO1xyXG4gICAgICBcclxuICAgICAgY2FzZSAncHVibGlzaE1hdGNoRXZlbnQnOlxyXG4gICAgICAgIHJldHVybiBhd2FpdCBwdWJsaXNoTWF0Y2hFdmVudCh1c2VySWQsIGFyZ3Mucm9vbUlkLCBhcmdzLm1hdGNoRGF0YSk7XHJcbiAgICAgIFxyXG4gICAgICBjYXNlICdwdWJsaXNoTWVtYmVyRXZlbnQnOlxyXG4gICAgICAgIHJldHVybiBhd2FpdCBwdWJsaXNoTWVtYmVyRXZlbnQodXNlcklkLCBhcmdzLnJvb21JZCwgYXJncy5tZW1iZXJEYXRhKTtcclxuICAgICAgXHJcbiAgICAgIGNhc2UgJ3B1Ymxpc2hSb2xlRXZlbnQnOlxyXG4gICAgICAgIHJldHVybiBhd2FpdCBwdWJsaXNoUm9sZUV2ZW50KHVzZXJJZCwgYXJncy5yb29tSWQsIGFyZ3Mucm9sZURhdGEpO1xyXG4gICAgICBcclxuICAgICAgY2FzZSAncHVibGlzaE1vZGVyYXRpb25FdmVudCc6XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHB1Ymxpc2hNb2RlcmF0aW9uRXZlbnQodXNlcklkLCBhcmdzLnJvb21JZCwgYXJncy5tb2RlcmF0aW9uRGF0YSk7XHJcbiAgICAgIFxyXG4gICAgICBjYXNlICdwdWJsaXNoU2NoZWR1bGVFdmVudCc6XHJcbiAgICAgICAgcmV0dXJuIGF3YWl0IHB1Ymxpc2hTY2hlZHVsZUV2ZW50KHVzZXJJZCwgYXJncy5yb29tSWQsIGFyZ3Muc2NoZWR1bGVEYXRhKTtcclxuICAgICAgXHJcbiAgICAgIGNhc2UgJ3B1Ymxpc2hUaGVtZUV2ZW50JzpcclxuICAgICAgICByZXR1cm4gYXdhaXQgcHVibGlzaFRoZW1lRXZlbnQodXNlcklkLCBhcmdzLnJvb21JZCwgYXJncy50aGVtZURhdGEpO1xyXG4gICAgICBcclxuICAgICAgY2FzZSAncHVibGlzaFNldHRpbmdzRXZlbnQnOlxyXG4gICAgICAgIHJldHVybiBhd2FpdCBwdWJsaXNoU2V0dGluZ3NFdmVudCh1c2VySWQsIGFyZ3Mucm9vbUlkLCBhcmdzLnNldHRpbmdzRGF0YSk7XHJcbiAgICAgIFxyXG4gICAgICBjYXNlICdwdWJsaXNoQ2hhdEV2ZW50JzpcclxuICAgICAgICByZXR1cm4gYXdhaXQgcHVibGlzaENoYXRFdmVudCh1c2VySWQsIGFyZ3Mucm9vbUlkLCBhcmdzLmNoYXREYXRhKTtcclxuICAgICAgXHJcbiAgICAgIGNhc2UgJ3B1Ymxpc2hTdWdnZXN0aW9uRXZlbnQnOlxyXG4gICAgICAgIHJldHVybiBhd2FpdCBwdWJsaXNoU3VnZ2VzdGlvbkV2ZW50KHVzZXJJZCwgYXJncy5yb29tSWQsIGFyZ3Muc3VnZ2VzdGlvbkRhdGEpO1xyXG4gICAgICBcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wZXJhY2nDs24gbm8gc29wb3J0YWRhOiAke2ZpZWxkTmFtZX1gKTtcclxuICAgIH1cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcihg4p2MIEVycm9yIGVuICR7ZmllbGROYW1lfTpgLCBlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogVmFsaWRhciBxdWUgZWwgdXN1YXJpbyB0aWVuZSBhY2Nlc28gYSBsYSBzYWxhXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiB2YWxpZGF0ZVJvb21BY2Nlc3ModXNlcklkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IEdldENvbW1hbmQoe1xyXG4gICAgICBUYWJsZU5hbWU6IHByb2Nlc3MuZW52LlJPT01fTUVNQkVSU19UQUJMRSEsXHJcbiAgICAgIEtleTogeyByb29tSWQsIHVzZXJJZCB9LFxyXG4gICAgfSkpO1xyXG5cclxuICAgIHJldHVybiByZXNwb25zZS5JdGVtPy5pc0FjdGl2ZSA9PT0gdHJ1ZTtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS53YXJuKCfimqDvuI8gRXJyb3IgdmFsaWRhbmRvIGFjY2VzbyBhIHNhbGE6JywgZXJyb3IpO1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIFB1YmxpY2FyIGV2ZW50byBnZW5lcmFsIGRlIHNhbGFcclxuICovXHJcbmFzeW5jIGZ1bmN0aW9uIHB1Ymxpc2hSb29tRXZlbnQodXNlcklkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCBldmVudFR5cGU6IHN0cmluZywgZGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAvLyBWYWxpZGFyIGFjY2Vzb1xyXG4gIGNvbnN0IGhhc0FjY2VzcyA9IGF3YWl0IHZhbGlkYXRlUm9vbUFjY2Vzcyh1c2VySWQsIHJvb21JZCk7XHJcbiAgaWYgKCFoYXNBY2Nlc3MpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignVXN1YXJpbyBubyB0aWVuZSBhY2Nlc28gYSBlc3RhIHNhbGEnKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGV2ZW50ID0ge1xyXG4gICAgaWQ6IGByb29tXyR7cm9vbUlkfV8ke0RhdGUubm93KCl9YCxcclxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgcm9vbUlkLFxyXG4gICAgZXZlbnRUeXBlLFxyXG4gICAgZGF0YTogdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnID8gZGF0YSA6IEpTT04uc3RyaW5naWZ5KGRhdGEpLFxyXG4gIH07XHJcblxyXG4gIGNvbnNvbGUubG9nKGDwn5OhIFB1Ymxpc2hpbmcgcm9vbSBldmVudDogJHtldmVudFR5cGV9IGZvciByb29tICR7cm9vbUlkfWApO1xyXG4gIHJldHVybiBldmVudDtcclxufVxyXG5cclxuLyoqXHJcbiAqIFB1YmxpY2FyIGV2ZW50byBkZSB2b3RvXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoVm90ZUV2ZW50KHVzZXJJZDogc3RyaW5nLCByb29tSWQ6IHN0cmluZywgdm90ZURhdGE6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgY29uc3QgaGFzQWNjZXNzID0gYXdhaXQgdmFsaWRhdGVSb29tQWNjZXNzKHVzZXJJZCwgcm9vbUlkKTtcclxuICBpZiAoIWhhc0FjY2Vzcykge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdVc3VhcmlvIG5vIHRpZW5lIGFjY2VzbyBhIGVzdGEgc2FsYScpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgcGFyc2VkRGF0YSA9IHR5cGVvZiB2b3RlRGF0YSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKHZvdGVEYXRhKSA6IHZvdGVEYXRhO1xyXG4gIFxyXG4gIGNvbnN0IGV2ZW50ID0ge1xyXG4gICAgaWQ6IGB2b3RlXyR7cm9vbUlkfV8ke3VzZXJJZH1fJHtEYXRlLm5vdygpfWAsXHJcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgIHJvb21JZCxcclxuICAgIGV2ZW50VHlwZTogJ1ZPVEVfVVBEQVRFJyxcclxuICAgIHVzZXJJZCxcclxuICAgIG1lZGlhSWQ6IHBhcnNlZERhdGEubWVkaWFJZCxcclxuICAgIHZvdGVUeXBlOiBwYXJzZWREYXRhLnZvdGVUeXBlIHx8ICdMSUtFJyxcclxuICAgIHByb2dyZXNzOiBwYXJzZWREYXRhLnByb2dyZXNzIHx8IHtcclxuICAgICAgdG90YWxWb3RlczogMCxcclxuICAgICAgbGlrZXNDb3VudDogMCxcclxuICAgICAgZGlzbGlrZXNDb3VudDogMCxcclxuICAgICAgc2tpcHNDb3VudDogMCxcclxuICAgICAgcmVtYWluaW5nVXNlcnM6IDAsXHJcbiAgICAgIHBlcmNlbnRhZ2U6IDBcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBjb25zb2xlLmxvZyhg8J+Xs++4jyBQdWJsaXNoaW5nIHZvdGUgZXZlbnQgZm9yIHJvb20gJHtyb29tSWR9LCB1c2VyICR7dXNlcklkfWApO1xyXG4gIHJldHVybiBldmVudDtcclxufVxyXG5cclxuLyoqXHJcbiAqIFB1YmxpY2FyIGV2ZW50byBkZSBtYXRjaCBlbmNvbnRyYWRvXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoTWF0Y2hFdmVudCh1c2VySWQ6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcsIG1hdGNoRGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICBjb25zdCBoYXNBY2Nlc3MgPSBhd2FpdCB2YWxpZGF0ZVJvb21BY2Nlc3ModXNlcklkLCByb29tSWQpO1xyXG4gIGlmICghaGFzQWNjZXNzKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1VzdWFyaW8gbm8gdGllbmUgYWNjZXNvIGEgZXN0YSBzYWxhJyk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBwYXJzZWREYXRhID0gdHlwZW9mIG1hdGNoRGF0YSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKG1hdGNoRGF0YSkgOiBtYXRjaERhdGE7XHJcbiAgXHJcbiAgY29uc3QgZXZlbnQgPSB7XHJcbiAgICBpZDogYG1hdGNoXyR7cm9vbUlkfV8ke0RhdGUubm93KCl9YCxcclxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgcm9vbUlkLFxyXG4gICAgZXZlbnRUeXBlOiAnTUFUQ0hfRk9VTkQnLFxyXG4gICAgbWF0Y2hJZDogcGFyc2VkRGF0YS5tYXRjaElkIHx8IGBtYXRjaF8ke3Jvb21JZH1fJHtwYXJzZWREYXRhLm1lZGlhSWR9YCxcclxuICAgIG1lZGlhSWQ6IHBhcnNlZERhdGEubWVkaWFJZCxcclxuICAgIG1lZGlhVGl0bGU6IHBhcnNlZERhdGEubWVkaWFUaXRsZSB8fCAnVW5rbm93biBNb3ZpZScsXHJcbiAgICBwYXJ0aWNpcGFudHM6IHBhcnNlZERhdGEucGFydGljaXBhbnRzIHx8IFtdLFxyXG4gICAgY29uc2Vuc3VzVHlwZTogcGFyc2VkRGF0YS5jb25zZW5zdXNUeXBlIHx8ICdVTkFOSU1PVVMnXHJcbiAgfTtcclxuXHJcbiAgY29uc29sZS5sb2coYPCfjokgUHVibGlzaGluZyBtYXRjaCBldmVudCBmb3Igcm9vbSAke3Jvb21JZH06ICR7cGFyc2VkRGF0YS5tZWRpYVRpdGxlfWApO1xyXG4gIHJldHVybiBldmVudDtcclxufVxyXG5cclxuLyoqXHJcbiAqIFB1YmxpY2FyIGV2ZW50byBkZSBtaWVtYnJvXHJcbiAqL1xyXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoTWVtYmVyRXZlbnQodXNlcklkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCBtZW1iZXJEYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gIGNvbnN0IGhhc0FjY2VzcyA9IGF3YWl0IHZhbGlkYXRlUm9vbUFjY2Vzcyh1c2VySWQsIHJvb21JZCk7XHJcbiAgaWYgKCFoYXNBY2Nlc3MpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignVXN1YXJpbyBubyB0aWVuZSBhY2Nlc28gYSBlc3RhIHNhbGEnKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IHBhcnNlZERhdGEgPSB0eXBlb2YgbWVtYmVyRGF0YSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKG1lbWJlckRhdGEpIDogbWVtYmVyRGF0YTtcclxuICBcclxuICBjb25zdCBldmVudCA9IHtcclxuICAgIGlkOiBgbWVtYmVyXyR7cm9vbUlkfV8ke3VzZXJJZH1fJHtEYXRlLm5vdygpfWAsXHJcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgIHJvb21JZCxcclxuICAgIGV2ZW50VHlwZTogJ01FTUJFUl9VUERBVEUnLFxyXG4gICAgdXNlcklkOiBwYXJzZWREYXRhLnVzZXJJZCB8fCB1c2VySWQsXHJcbiAgICBhY3Rpb246IHBhcnNlZERhdGEuYWN0aW9uIHx8ICdKT0lORUQnLFxyXG4gICAgbWVtYmVyQ291bnQ6IHBhcnNlZERhdGEubWVtYmVyQ291bnQgfHwgMSxcclxuICAgIG1lbWJlckRhdGE6IHBhcnNlZERhdGEubWVtYmVyRGF0YSB8fCBudWxsXHJcbiAgfTtcclxuXHJcbiAgY29uc29sZS5sb2coYPCfkaUgUHVibGlzaGluZyBtZW1iZXIgZXZlbnQgZm9yIHJvb20gJHtyb29tSWR9OiAke3BhcnNlZERhdGEuYWN0aW9ufWApO1xyXG4gIHJldHVybiBldmVudDtcclxufVxyXG5cclxuLyoqXHJcbiAqIFB1YmxpY2FyIGV2ZW50b3MgZGUgY2FyYWN0ZXLDrXN0aWNhcyBhdmFuemFkYXMgKHN0dWJzIHBhcmEgZnV0dXJvKVxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gcHVibGlzaFJvbGVFdmVudCh1c2VySWQ6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcsIHJvbGVEYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gIGNvbnNvbGUubG9nKGDwn5GRIFJvbGUgZXZlbnQgKGZ1dHVyZSBmZWF0dXJlKTogJHtyb29tSWR9YCk7XHJcbiAgcmV0dXJuIHsgaWQ6IGByb2xlXyR7RGF0ZS5ub3coKX1gLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgcm9vbUlkLCBldmVudFR5cGU6ICdST0xFX1VQREFURScgfTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcHVibGlzaE1vZGVyYXRpb25FdmVudCh1c2VySWQ6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcsIG1vZGVyYXRpb25EYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gIGNvbnNvbGUubG9nKGDwn5uh77iPIE1vZGVyYXRpb24gZXZlbnQgKGZ1dHVyZSBmZWF0dXJlKTogJHtyb29tSWR9YCk7XHJcbiAgcmV0dXJuIHsgaWQ6IGBtb2RfJHtEYXRlLm5vdygpfWAsIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLCByb29tSWQsIGV2ZW50VHlwZTogJ01PREVSQVRJT05fQUNUSU9OJyB9O1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoU2NoZWR1bGVFdmVudCh1c2VySWQ6IHN0cmluZywgcm9vbUlkOiBzdHJpbmcsIHNjaGVkdWxlRGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICBjb25zb2xlLmxvZyhg8J+ThSBTY2hlZHVsZSBldmVudCAoZnV0dXJlIGZlYXR1cmUpOiAke3Jvb21JZH1gKTtcclxuICByZXR1cm4geyBpZDogYHNjaGVkdWxlXyR7RGF0ZS5ub3coKX1gLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgcm9vbUlkLCBldmVudFR5cGU6ICdTQ0hFRFVMRV9VUERBVEUnIH07XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHB1Ymxpc2hUaGVtZUV2ZW50KHVzZXJJZDogc3RyaW5nLCByb29tSWQ6IHN0cmluZywgdGhlbWVEYXRhOiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gIGNvbnNvbGUubG9nKGDwn46oIFRoZW1lIGV2ZW50IChmdXR1cmUgZmVhdHVyZSk6ICR7cm9vbUlkfWApO1xyXG4gIHJldHVybiB7IGlkOiBgdGhlbWVfJHtEYXRlLm5vdygpfWAsIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLCByb29tSWQsIGV2ZW50VHlwZTogJ1RIRU1FX0NIQU5HRScgfTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcHVibGlzaFNldHRpbmdzRXZlbnQodXNlcklkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCBzZXR0aW5nc0RhdGE6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgY29uc29sZS5sb2coYOKame+4jyBTZXR0aW5ncyBldmVudCAoZnV0dXJlIGZlYXR1cmUpOiAke3Jvb21JZH1gKTtcclxuICByZXR1cm4geyBpZDogYHNldHRpbmdzXyR7RGF0ZS5ub3coKX1gLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgcm9vbUlkLCBldmVudFR5cGU6ICdTRVRUSU5HU19DSEFOR0UnIH07XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIHB1Ymxpc2hDaGF0RXZlbnQodXNlcklkOiBzdHJpbmcsIHJvb21JZDogc3RyaW5nLCBjaGF0RGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICBjb25zb2xlLmxvZyhg8J+SrCBDaGF0IGV2ZW50IChmdXR1cmUgZmVhdHVyZSk6ICR7cm9vbUlkfWApO1xyXG4gIHJldHVybiB7IGlkOiBgY2hhdF8ke0RhdGUubm93KCl9YCwgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIHJvb21JZCwgZXZlbnRUeXBlOiAnQ0hBVF9NRVNTQUdFJyB9O1xyXG59XHJcblxyXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoU3VnZ2VzdGlvbkV2ZW50KHVzZXJJZDogc3RyaW5nLCByb29tSWQ6IHN0cmluZywgc3VnZ2VzdGlvbkRhdGE6IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgY29uc29sZS5sb2coYPCfkqEgU3VnZ2VzdGlvbiBldmVudCAoZnV0dXJlIGZlYXR1cmUpOiAke3Jvb21JZH1gKTtcclxuICByZXR1cm4geyBpZDogYHN1Z2dlc3Rpb25fJHtEYXRlLm5vdygpfWAsIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLCByb29tSWQsIGV2ZW50VHlwZTogJ0NPTlRFTlRfU1VHR0VTVElPTicgfTtcclxufSJdfQ==