"use strict";
/**
 * Content Filter Service - Extracted from MONOLITH-TRINITY-CACHE-FINAL.js
 * CRITICAL BUSINESS LOGIC: 50-movie room creation with genre prioritization
 * CRITICAL FIX: Includes JA/KO language support and "The Matrix" detection
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ContentFilterService = void 0;
const axios_1 = __importDefault(require("axios"));
class ContentFilterService {
    constructor(apiKey) {
        this.apiKey = apiKey || process.env.TMDB_API_KEY || '';
        this.baseUrl = 'https://api.themoviedb.org/3';
        if (!this.apiKey) {
            throw new Error('TMDB_API_KEY is required');
        }
        console.log('üéØ ContentFilterService initialized with IMMUTABLE BUSINESS LOGIC');
    }
    async createFilteredRoom(criteria) {
        console.log(`üéØ IMMUTABLE BUSINESS LOGIC: Starting room creation`, criteria);
        try {
            this.validateInput(criteria);
            const endpoint = this.configureExclusiveEndpoint(criteria.mediaType);
            const validItems = await this.fetchAndFilterLoop(criteria, endpoint);
            if (validItems.length !== 50) {
                console.warn(`‚ö†Ô∏è BUSINESS LOGIC WARNING: Expected exactly 50 items, got ${validItems.length}`);
                // Allow graceful shortage handling for western-only filtering
                if (validItems.length === 0) {
                    throw new Error(`BUSINESS LOGIC FAILURE: No valid items found for ${criteria.mediaType}`);
                }
            }
            console.log(`‚úÖ IMMUTABLE BUSINESS LOGIC SUCCESS: Generated ${validItems.length} valid ${criteria.mediaType} items`);
            return validItems;
        }
        catch (error) {
            console.error(`‚ùå IMMUTABLE BUSINESS LOGIC ERROR:`, error);
            throw error;
        }
    }
    validateInput(criteria) {
        if (!criteria.mediaType || !['TV', 'MOVIE'].includes(criteria.mediaType)) {
            throw new Error(`Invalid mediaType: ${criteria.mediaType}. Must be 'TV' or 'MOVIE'`);
        }
        if (!criteria.genres || !Array.isArray(criteria.genres)) {
            throw new Error('Genres must be an array');
        }
        if (criteria.genres.length > 2) {
            throw new Error('Maximum 2 genres allowed');
        }
        console.log(`‚úÖ INPUT VALIDATION: MediaType=${criteria.mediaType}, Genres=[${criteria.genres.join(',')}]`);
    }
    configureExclusiveEndpoint(mediaType) {
        let endpoint;
        if (mediaType === 'TV') {
            endpoint = '/discover/tv';
            console.log(`üì∫ EXCLUSIVE ENDPOINT: ${endpoint} configured for TV content`);
        }
        else if (mediaType === 'MOVIE') {
            endpoint = '/discover/movie';
            console.log(`üé¨ EXCLUSIVE ENDPOINT: ${endpoint} configured for MOVIE content`);
        }
        else {
            throw new Error(`CRITICAL: Invalid mediaType ${mediaType}`);
        }
        return endpoint;
    }
    async fetchAndFilterLoop(criteria, endpoint) {
        const validItems = [];
        const usedIds = new Set();
        console.log(`üîÑ FETCH & FILTER LOOP: Starting for ${criteria.mediaType}`);
        // Priority 1: BOTH genres (AND logic)
        if (criteria.genres.length > 0) {
            console.log(`ü•á INTENTO 1 (AND): Fetching with BOTH genres [${criteria.genres.join(' AND ')}]`);
            await this.fetchBatchWithGenres(criteria, endpoint, criteria.genres.join(','), validItems, usedIds, 1);
        }
        // Priority 2: ANY genre (OR logic)
        if (criteria.genres.length > 0 && validItems.length < 50) {
            console.log(`ü•à INTENTO 2 (OR): Fetching with ANY genre [${criteria.genres.join(' OR ')}]`);
            await this.fetchBatchWithGenres(criteria, endpoint, criteria.genres.join('|'), validItems, usedIds, 2);
        }
        // Priority 3: Popular content (no genre filter)
        if (validItems.length < 50) {
            console.log(`ü•â RELLENO FINAL: Fetching popular ${criteria.mediaType} content`);
            await this.fetchBatchWithGenres(criteria, endpoint, null, validItems, usedIds, 3);
        }
        console.log(`üéØ FETCH & FILTER LOOP COMPLETE: ${validItems.length} valid items collected`);
        return validItems.slice(0, 50);
    }
    async fetchBatchWithGenres(criteria, endpoint, genreQuery, validItems, usedIds, priority) {
        let page = 1;
        const maxPages = 5;
        while (validItems.length < 50 && page <= maxPages) {
            console.log(`üìÑ Fetching page ${page} for priority ${priority}`);
            const batch = await this.fetchTMDBBatch(criteria.mediaType, endpoint, genreQuery, page);
            if (!batch || batch.length === 0) {
                console.log(`‚ö†Ô∏è No more results for priority ${priority}, page ${page}`);
                break;
            }
            for (const item of batch) {
                if (validItems.length >= 50)
                    break;
                if (usedIds.has(item.id)) {
                    continue;
                }
                const validatedItem = this.applyQualityGate(item, criteria.mediaType, priority);
                if (validatedItem) {
                    validItems.push(validatedItem);
                    usedIds.add(item.id);
                }
            }
            page++;
        }
        console.log(`‚úÖ Priority ${priority} complete: ${validItems.length} total valid items`);
    }
    async fetchTMDBBatch(mediaType, endpoint, genreQuery, page) {
        const params = {
            api_key: this.apiKey,
            language: 'es-ES',
            page: page,
            sort_by: 'popularity.desc',
            include_adult: false,
            // CRITICAL FIX: Added 'ja' (Japanese) and 'ko' (Korean) to western languages
            'with_original_language': 'en|es|fr|it|de|pt|ja|ko'
        };
        if (genreQuery) {
            params.with_genres = genreQuery;
        }
        const url = `${this.baseUrl}${endpoint}`;
        console.log(`üåê TMDB REQUEST: ${endpoint} (page ${page})`);
        console.log(`üö® TMDB_URL_GENERATED: ${url}?${new URLSearchParams(params).toString()}`);
        try {
            const response = await axios_1.default.get(url, { params });
            return response.data.results || [];
        }
        catch (error) {
            console.error(`‚ùå TMDB API ERROR:`, error);
            throw error;
        }
    }
    /**
     * CRITICAL BUSINESS LOGIC: Quality Gate with "The Matrix" Detection
     * This prevents movies from appearing in TV rooms and vice versa
     */
    applyQualityGate(tmdbItem, expectedMediaType, priority) {
        if (!tmdbItem || !tmdbItem.id) {
            return null;
        }
        // CRITICAL FIX: Added 'ja' (Japanese) and 'ko' (Korean) to western languages
        const westernLanguages = ['en', 'es', 'fr', 'it', 'de', 'pt', 'ja', 'ko'];
        if (!westernLanguages.includes(tmdbItem.original_language)) {
            console.log(`‚ùå QUALITY GATE REJECT: Non-western language "${tmdbItem.original_language}" for item ${tmdbItem.id}`);
            return null;
        }
        if (!tmdbItem.overview || typeof tmdbItem.overview !== 'string' || tmdbItem.overview.trim().length === 0) {
            console.log(`‚ùå QUALITY GATE REJECT: Empty overview for item ${tmdbItem.id}`);
            return null;
        }
        if (tmdbItem.overview.includes('Descripci√≥n no disponible')) {
            console.log(`‚ùå QUALITY GATE REJECT: "Descripci√≥n no disponible" found in item ${tmdbItem.id}`);
            return null;
        }
        if (!tmdbItem.poster_path || typeof tmdbItem.poster_path !== 'string' || tmdbItem.poster_path.trim().length === 0) {
            console.log(`‚ùå QUALITY GATE REJECT: Missing poster_path for item ${tmdbItem.id}`);
            return null;
        }
        // CRITICAL BUSINESS LOGIC: Detect movies in TV rooms ("The Matrix" Detection)
        if (expectedMediaType === 'TV') {
            if (tmdbItem.media_type === 'movie') {
                console.error(`üö® CRITICAL: MOVIE DETECTED in TV room - Item ${tmdbItem.id} (media_type: movie)`);
                throw new Error(`CRITICAL: MOVIE DETECTED in TV room - Item ${tmdbItem.id} has media_type: movie`);
            }
            if (tmdbItem.title && tmdbItem.release_date && !tmdbItem.name && !tmdbItem.first_air_date) {
                console.error(`üö® CRITICAL: MOVIE DETECTED in TV room - Item ${tmdbItem.id} ("${tmdbItem.title}") has movie field structure`);
                throw new Error(`CRITICAL: MOVIE DETECTED in TV room - Item ${tmdbItem.id} ("${tmdbItem.title}") has movie fields (title/release_date) instead of TV fields (name/first_air_date)`);
            }
            if (!tmdbItem.name || !tmdbItem.first_air_date) {
                console.log(`‚ùå QUALITY GATE REJECT: Item ${tmdbItem.id} missing TV fields (name/first_air_date)`);
                return null;
            }
        }
        if (expectedMediaType === 'MOVIE') {
            if (tmdbItem.media_type === 'tv') {
                console.log(`‚ùå QUALITY GATE REJECT: TV item ${tmdbItem.id} in MOVIE room (media_type)`);
                return null;
            }
            if (tmdbItem.name && tmdbItem.first_air_date && !tmdbItem.title && !tmdbItem.release_date) {
                console.log(`‚ùå QUALITY GATE REJECT: TV item ${tmdbItem.id} ("${tmdbItem.name}") in MOVIE room (field structure)`);
                return null;
            }
            if (!tmdbItem.title || !tmdbItem.release_date) {
                console.log(`‚ùå QUALITY GATE REJECT: Item ${tmdbItem.id} missing MOVIE fields (title/release_date)`);
                return null;
            }
        }
        const title = expectedMediaType === 'TV' ? tmdbItem.name : tmdbItem.title;
        const releaseDate = expectedMediaType === 'TV' ? tmdbItem.first_air_date : tmdbItem.release_date;
        const validItem = {
            tmdbId: tmdbItem.id.toString(),
            mediaType: expectedMediaType,
            title: title.trim(),
            posterPath: `https://image.tmdb.org/t/p/w500${tmdbItem.poster_path}`,
            overview: tmdbItem.overview.trim(),
            genreIds: tmdbItem.genre_ids || [],
            voteAverage: tmdbItem.vote_average || 0,
            voteCount: tmdbItem.vote_count || 0,
            popularity: tmdbItem.popularity || 0,
            releaseDate,
            priority,
            addedAt: new Date().toISOString()
        };
        console.log(`‚úÖ QUALITY GATE PASS: ${expectedMediaType} item "${title}" (ID: ${tmdbItem.id}, Lang: ${tmdbItem.original_language})`);
        return validItem;
    }
    async getAvailableGenres(mediaType) {
        console.log(`üé≠ ContentFilterService: Getting available genres for ${mediaType}`);
        const endpoint = mediaType === 'MOVIE' ? '/genre/movie/list' : '/genre/tv/list';
        const url = `${this.baseUrl}${endpoint}`;
        try {
            const response = await axios_1.default.get(url, {
                params: {
                    api_key: this.apiKey,
                    language: 'es-ES'
                }
            });
            return response.data.genres || [];
        }
        catch (error) {
            console.error(`‚ùå Error getting genres:`, error);
            throw error;
        }
    }
}
exports.ContentFilterService = ContentFilterService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1maWx0ZXItc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRlbnQtZmlsdGVyLXNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7Ozs7OztBQUVILGtEQUEwQjtBQXdCMUIsTUFBYSxvQkFBb0I7SUFJL0IsWUFBWSxNQUFlO1FBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQztRQUN2RCxJQUFJLENBQUMsT0FBTyxHQUFHLDhCQUE4QixDQUFDO1FBRTlDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1FQUFtRSxDQUFDLENBQUM7SUFDbkYsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxRQUF3QjtRQUMvQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFEQUFxRCxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTdFLElBQUksQ0FBQztZQUNILElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDN0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNyRSxNQUFNLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFFckUsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLEVBQUUsRUFBRSxDQUFDO2dCQUM3QixPQUFPLENBQUMsSUFBSSxDQUFDLDZEQUE2RCxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDL0YsOERBQThEO2dCQUM5RCxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxF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bnQiOlsiLyoqXHJcbiAqIENvbnRlbnQgRmlsdGVyIFNlcnZpY2UgLSBFeHRyYWN0ZWQgZnJvbSBNT05PTElUSC1UUklOSVRZLUNBQ0hFLUZJTkFMLmpzXHJcbiAqIENSSVRJQ0FMIEJVU0lORVNTIExPR0lDOiA1MC1tb3ZpZSByb29tIGNyZWF0aW9uIHdpdGggZ2VucmUgcHJpb3JpdGl6YXRpb25cclxuICogQ1JJVElDQUwgRklYOiBJbmNsdWRlcyBKQS9LTyBsYW5ndWFnZSBzdXBwb3J0IGFuZCBcIlRoZSBNYXRyaXhcIiBkZXRlY3Rpb25cclxuICovXHJcblxyXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBUTURCSXRlbSB9IGZyb20gJy4vZW5oYW5jZWQtdG1kYi1jbGllbnQnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGaWx0ZXJDcml0ZXJpYSB7XHJcbiAgbWVkaWFUeXBlOiAnVFYnIHwgJ01PVklFJztcclxuICBnZW5yZXM6IG51bWJlcltdO1xyXG4gIHJvb21JZD86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBWYWxpZGF0ZWRJdGVtIHtcclxuICB0bWRiSWQ6IHN0cmluZztcclxuICBtZWRpYVR5cGU6IHN0cmluZztcclxuICB0aXRsZTogc3RyaW5nO1xyXG4gIHBvc3RlclBhdGg6IHN0cmluZztcclxuICBvdmVydmlldzogc3RyaW5nO1xyXG4gIGdlbnJlSWRzOiBudW1iZXJbXTtcclxuICB2b3RlQXZlcmFnZTogbnVtYmVyO1xyXG4gIHZvdGVDb3VudDogbnVtYmVyO1xyXG4gIHBvcHVsYXJpdHk6IG51bWJlcjtcclxuICByZWxlYXNlRGF0ZTogc3RyaW5nO1xyXG4gIHByaW9yaXR5OiBudW1iZXI7XHJcbiAgYWRkZWRBdDogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQ29udGVudEZpbHRlclNlcnZpY2Uge1xyXG4gIHByaXZhdGUgYXBpS2V5OiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBiYXNlVXJsOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGFwaUtleT86IHN0cmluZykge1xyXG4gICAgdGhpcy5hcGlLZXkgPSBhcGlLZXkgfHwgcHJvY2Vzcy5lbnYuVE1EQl9BUElfS0VZIHx8ICcnO1xyXG4gICAgdGhpcy5iYXNlVXJsID0gJ2h0dHBzOi8vYXBpLnRoZW1vdmllZGIub3JnLzMnO1xyXG4gICAgXHJcbiAgICBpZiAoIXRoaXMuYXBpS2V5KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignVE1EQl9BUElfS0VZIGlzIHJlcXVpcmVkJyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnNvbGUubG9nKCfwn46vIENvbnRlbnRGaWx0ZXJTZXJ2aWNlIGluaXRpYWxpemVkIHdpdGggSU1NVVRBQkxFIEJVU0lORVNTIExPR0lDJyk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBjcmVhdGVGaWx0ZXJlZFJvb20oY3JpdGVyaWE6IEZpbHRlckNyaXRlcmlhKTogUHJvbWlzZTxWYWxpZGF0ZWRJdGVtW10+IHtcclxuICAgIGNvbnNvbGUubG9nKGDwn46vIElNTVVUQUJMRSBCVVNJTkVTUyBMT0dJQzogU3RhcnRpbmcgcm9vbSBjcmVhdGlvbmAsIGNyaXRlcmlhKTtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpcy52YWxpZGF0ZUlucHV0KGNyaXRlcmlhKTtcclxuICAgICAgY29uc3QgZW5kcG9pbnQgPSB0aGlzLmNvbmZpZ3VyZUV4Y2x1c2l2ZUVuZHBvaW50KGNyaXRlcmlhLm1lZGlhVHlwZSk7XHJcbiAgICAgIGNvbnN0IHZhbGlkSXRlbXMgPSBhd2FpdCB0aGlzLmZldGNoQW5kRmlsdGVyTG9vcChjcml0ZXJpYSwgZW5kcG9pbnQpO1xyXG4gICAgICBcclxuICAgICAgaWYgKHZhbGlkSXRlbXMubGVuZ3RoICE9PSA1MCkge1xyXG4gICAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIEJVU0lORVNTIExPR0lDIFdBUk5JTkc6IEV4cGVjdGVkIGV4YWN0bHkgNTAgaXRlbXMsIGdvdCAke3ZhbGlkSXRlbXMubGVuZ3RofWApO1xyXG4gICAgICAgIC8vIEFsbG93IGdyYWNlZnVsIHNob3J0YWdlIGhhbmRsaW5nIGZvciB3ZXN0ZXJuLW9ubHkgZmlsdGVyaW5nXHJcbiAgICAgICAgaWYgKHZhbGlkSXRlbXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJVU0lORVNTIExPR0lDIEZBSUxVUkU6IE5vIHZhbGlkIGl0ZW1zIGZvdW5kIGZvciAke2NyaXRlcmlhLm1lZGlhVHlwZX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgSU1NVVRBQkxFIEJVU0lORVNTIExPR0lDIFNVQ0NFU1M6IEdlbmVyYXRlZCAke3ZhbGlkSXRlbXMubGVuZ3RofSB2YWxpZCAke2NyaXRlcmlhLm1lZGlhVHlwZX0gaXRlbXNgKTtcclxuICAgICAgcmV0dXJuIHZhbGlkSXRlbXM7XHJcbiAgICAgIFxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihg4p2MIElNTVVUQUJMRSBCVVNJTkVTUyBMT0dJQyBFUlJPUjpgLCBlcnJvcik7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KGNyaXRlcmlhOiBGaWx0ZXJDcml0ZXJpYSk6IHZvaWQge1xyXG4gICAgaWYgKCFjcml0ZXJpYS5tZWRpYVR5cGUgfHwgIVsnVFYnLCAnTU9WSUUnXS5pbmNsdWRlcyhjcml0ZXJpYS5tZWRpYVR5cGUpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBtZWRpYVR5cGU6ICR7Y3JpdGVyaWEubWVkaWFUeXBlfS4gTXVzdCBiZSAnVFYnIG9yICdNT1ZJRSdgKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgaWYgKCFjcml0ZXJpYS5nZW5yZXMgfHwgIUFycmF5LmlzQXJyYXkoY3JpdGVyaWEuZ2VucmVzKSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dlbnJlcyBtdXN0IGJlIGFuIGFycmF5Jyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGlmIChjcml0ZXJpYS5nZW5yZXMubGVuZ3RoID4gMikge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ01heGltdW0gMiBnZW5yZXMgYWxsb3dlZCcpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zb2xlLmxvZyhg4pyFIElOUFVUIFZBTElEQVRJT046IE1lZGlhVHlwZT0ke2NyaXRlcmlhLm1lZGlhVHlwZX0sIEdlbnJlcz1bJHtjcml0ZXJpYS5nZW5yZXMuam9pbignLCcpfV1gKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29uZmlndXJlRXhjbHVzaXZlRW5kcG9pbnQobWVkaWFUeXBlOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgbGV0IGVuZHBvaW50OiBzdHJpbmc7XHJcbiAgICBcclxuICAgIGlmIChtZWRpYVR5cGUgPT09ICdUVicpIHtcclxuICAgICAgZW5kcG9pbnQgPSAnL2Rpc2NvdmVyL3R2JztcclxuICAgICAgY29uc29sZS5sb2coYPCfk7ogRVhDTFVTSVZFIEVORFBPSU5UOiAke2VuZHBvaW50fSBjb25maWd1cmVkIGZvciBUViBjb250ZW50YCk7XHJcbiAgICB9IGVsc2UgaWYgKG1lZGlhVHlwZSA9PT0gJ01PVklFJykge1xyXG4gICAgICBlbmRwb2ludCA9ICcvZGlzY292ZXIvbW92aWUnO1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+OrCBFWENMVVNJVkUgRU5EUE9JTlQ6ICR7ZW5kcG9pbnR9IGNvbmZpZ3VyZWQgZm9yIE1PVklFIGNvbnRlbnRgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ1JJVElDQUw6IEludmFsaWQgbWVkaWFUeXBlICR7bWVkaWFUeXBlfWApO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gZW5kcG9pbnQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGZldGNoQW5kRmlsdGVyTG9vcChjcml0ZXJpYTogRmlsdGVyQ3JpdGVyaWEsIGVuZHBvaW50OiBzdHJpbmcpOiBQcm9taXNlPFZhbGlkYXRlZEl0ZW1bXT4ge1xyXG4gICAgY29uc3QgdmFsaWRJdGVtczogVmFsaWRhdGVkSXRlbVtdID0gW107XHJcbiAgICBjb25zdCB1c2VkSWRzID0gbmV3IFNldDxudW1iZXI+KCk7XHJcbiAgICBcclxuICAgIGNvbnNvbGUubG9nKGDwn5SEIEZFVENIICYgRklMVEVSIExPT1A6IFN0YXJ0aW5nIGZvciAke2NyaXRlcmlhLm1lZGlhVHlwZX1gKTtcclxuICAgIFxyXG4gICAgLy8gUHJpb3JpdHkgMTogQk9USCBnZW5yZXMgKEFORCBsb2dpYylcclxuICAgIGlmIChjcml0ZXJpYS5nZW5yZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+lhyBJTlRFTlRPIDEgKEFORCk6IEZldGNoaW5nIHdpdGggQk9USCBnZW5yZXMgWyR7Y3JpdGVyaWEuZ2VucmVzLmpvaW4oJyBBTkQgJyl9XWApO1xyXG4gICAgICBhd2FpdCB0aGlzLmZldGNoQmF0Y2hXaXRoR2VucmVzKGNyaXRlcmlhLCBlbmRwb2ludCwgY3JpdGVyaWEuZ2VucmVzLmpvaW4oJywnKSwgdmFsaWRJdGVtcywgdXNlZElkcywgMSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIC8vIFByaW9yaXR5IDI6IEFOWSBnZW5yZSAoT1IgbG9naWMpXHJcbiAgICBpZiAoY3JpdGVyaWEuZ2VucmVzLmxlbmd0aCA+IDAgJiYgdmFsaWRJdGVtcy5sZW5ndGggPCA1MCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+liCBJTlRFTlRPIDIgKE9SKTogRmV0Y2hpbmcgd2l0aCBBTlkgZ2VucmUgWyR7Y3JpdGVyaWEuZ2VucmVzLmpvaW4oJyBPUiAnKX1dYCk7XHJcbiAgICAgIGF3YWl0IHRoaXMuZmV0Y2hCYXRjaFdpdGhHZW5yZXMoY3JpdGVyaWEsIGVuZHBvaW50LCBjcml0ZXJpYS5nZW5yZXMuam9pbignfCcpLCB2YWxpZEl0ZW1zLCB1c2VkSWRzLCAyKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gUHJpb3JpdHkgMzogUG9wdWxhciBjb250ZW50IChubyBnZW5yZSBmaWx0ZXIpXHJcbiAgICBpZiAodmFsaWRJdGVtcy5sZW5ndGggPCA1MCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg8J+liSBSRUxMRU5PIEZJTkFMOiBGZXRjaGluZyBwb3B1bGFyICR7Y3JpdGVyaWEubWVkaWFUeXBlfSBjb250ZW50YCk7XHJcbiAgICAgIGF3YWl0IHRoaXMuZmV0Y2hCYXRjaFdpdGhHZW5yZXMoY3JpdGVyaWEsIGVuZHBvaW50LCBudWxsLCB2YWxpZEl0ZW1zLCB1c2VkSWRzLCAzKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYPCfjq8gRkVUQ0ggJiBGSUxURVIgTE9PUCBDT01QTEVURTogJHt2YWxpZEl0ZW1zLmxlbmd0aH0gdmFsaWQgaXRlbXMgY29sbGVjdGVkYCk7XHJcbiAgICByZXR1cm4gdmFsaWRJdGVtcy5zbGljZSgwLCA1MCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGZldGNoQmF0Y2hXaXRoR2VucmVzKFxyXG4gICAgY3JpdGVyaWE6IEZpbHRlckNyaXRlcmlhLCBcclxuICAgIGVuZHBvaW50OiBzdHJpbmcsIFxyXG4gICAgZ2VucmVRdWVyeTogc3RyaW5nIHwgbnVsbCwgXHJcbiAgICB2YWxpZEl0ZW1zOiBWYWxpZGF0ZWRJdGVtW10sIFxyXG4gICAgdXNlZElkczogU2V0PG51bWJlcj4sIFxyXG4gICAgcHJpb3JpdHk6IG51bWJlclxyXG4gICk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgbGV0IHBhZ2UgPSAxO1xyXG4gICAgY29uc3QgbWF4UGFnZXMgPSA1O1xyXG4gICAgXHJcbiAgICB3aGlsZSAodmFsaWRJdGVtcy5sZW5ndGggPCA1MCAmJiBwYWdlIDw9IG1heFBhZ2VzKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDwn5OEIEZldGNoaW5nIHBhZ2UgJHtwYWdlfSBmb3IgcHJpb3JpdHkgJHtwcmlvcml0eX1gKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IGJhdGNoID0gYXdhaXQgdGhpcy5mZXRjaFRNREJCYXRjaChjcml0ZXJpYS5tZWRpYVR5cGUsIGVuZHBvaW50LCBnZW5yZVF1ZXJ5LCBwYWdlKTtcclxuICAgICAgXHJcbiAgICAgIGlmICghYmF0Y2ggfHwgYmF0Y2gubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOKaoO+4jyBObyBtb3JlIHJlc3VsdHMgZm9yIHByaW9yaXR5ICR7cHJpb3JpdHl9LCBwYWdlICR7cGFnZX1gKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGJhdGNoKSB7XHJcbiAgICAgICAgaWYgKHZhbGlkSXRlbXMubGVuZ3RoID49IDUwKSBicmVhaztcclxuICAgICAgICBcclxuICAgICAgICBpZiAodXNlZElkcy5oYXMoaXRlbS5pZCkpIHtcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zdCB2YWxpZGF0ZWRJdGVtID0gdGhpcy5hcHBseVF1YWxpdHlHYXRlKGl0ZW0sIGNyaXRlcmlhLm1lZGlhVHlwZSwgcHJpb3JpdHkpO1xyXG4gICAgICAgIGlmICh2YWxpZGF0ZWRJdGVtKSB7XHJcbiAgICAgICAgICB2YWxpZEl0ZW1zLnB1c2godmFsaWRhdGVkSXRlbSk7XHJcbiAgICAgICAgICB1c2VkSWRzLmFkZChpdGVtLmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHBhZ2UrKztcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYOKchSBQcmlvcml0eSAke3ByaW9yaXR5fSBjb21wbGV0ZTogJHt2YWxpZEl0ZW1zLmxlbmd0aH0gdG90YWwgdmFsaWQgaXRlbXNgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZmV0Y2hUTURCQmF0Y2goXHJcbiAgICBtZWRpYVR5cGU6IHN0cmluZywgXHJcbiAgICBlbmRwb2ludDogc3RyaW5nLCBcclxuICAgIGdlbnJlUXVlcnk6IHN0cmluZyB8IG51bGwsIFxyXG4gICAgcGFnZTogbnVtYmVyXHJcbiAgKTogUHJvbWlzZTxUTURCSXRlbVtdPiB7XHJcbiAgICBjb25zdCBwYXJhbXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IGJvb2xlYW4gfCBudW1iZXI+ID0ge1xyXG4gICAgICBhcGlfa2V5OiB0aGlzLmFwaUtleSxcclxuICAgICAgbGFuZ3VhZ2U6ICdlcy1FUycsXHJcbiAgICAgIHBhZ2U6IHBhZ2UsXHJcbiAgICAgIHNvcnRfYnk6ICdwb3B1bGFyaXR5LmRlc2MnLFxyXG4gICAgICBpbmNsdWRlX2FkdWx0OiBmYWxzZSxcclxuICAgICAgLy8gQ1JJVElDQUwgRklYOiBBZGRlZCAnamEnIChKYXBhbmVzZSkgYW5kICdrbycgKEtvcmVhbikgdG8gd2VzdGVybiBsYW5ndWFnZXNcclxuICAgICAgJ3dpdGhfb3JpZ2luYWxfbGFuZ3VhZ2UnOiAnZW58ZXN8ZnJ8aXR8ZGV8cHR8amF8a28nXHJcbiAgICB9O1xyXG4gICAgXHJcbiAgICBpZiAoZ2VucmVRdWVyeSkge1xyXG4gICAgICBwYXJhbXMud2l0aF9nZW5yZXMgPSBnZW5yZVF1ZXJ5O1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJhc2VVcmx9JHtlbmRwb2ludH1gO1xyXG4gICAgXHJcbiAgICBjb25zb2xlLmxvZyhg8J+MkCBUTURCIFJFUVVFU1Q6ICR7ZW5kcG9pbnR9IChwYWdlICR7cGFnZX0pYCk7XHJcbiAgICBjb25zb2xlLmxvZyhg8J+aqCBUTURCX1VSTF9HRU5FUkFURUQ6ICR7dXJsfT8ke25ldyBVUkxTZWFyY2hQYXJhbXMocGFyYW1zIGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4pLnRvU3RyaW5nKCl9YCk7XHJcbiAgICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KHVybCwgeyBwYXJhbXMgfSk7XHJcbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLnJlc3VsdHMgfHwgW107XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGDinYwgVE1EQiBBUEkgRVJST1I6YCwgZXJyb3IpO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENSSVRJQ0FMIEJVU0lORVNTIExPR0lDOiBRdWFsaXR5IEdhdGUgd2l0aCBcIlRoZSBNYXRyaXhcIiBEZXRlY3Rpb25cclxuICAgKiBUaGlzIHByZXZlbnRzIG1vdmllcyBmcm9tIGFwcGVhcmluZyBpbiBUViByb29tcyBhbmQgdmljZSB2ZXJzYVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwbHlRdWFsaXR5R2F0ZSh0bWRiSXRlbTogVE1EQkl0ZW0sIGV4cGVjdGVkTWVkaWFUeXBlOiBzdHJpbmcsIHByaW9yaXR5OiBudW1iZXIpOiBWYWxpZGF0ZWRJdGVtIHwgbnVsbCB7XHJcbiAgICBpZiAoIXRtZGJJdGVtIHx8ICF0bWRiSXRlbS5pZCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgLy8gQ1JJVElDQUwgRklYOiBBZGRlZCAnamEnIChKYXBhbmVzZSkgYW5kICdrbycgKEtvcmVhbikgdG8gd2VzdGVybiBsYW5ndWFnZXNcclxuICAgIGNvbnN0IHdlc3Rlcm5MYW5ndWFnZXMgPSBbJ2VuJywgJ2VzJywgJ2ZyJywgJ2l0JywgJ2RlJywgJ3B0JywgJ2phJywgJ2tvJ107XHJcbiAgICBpZiAoIXdlc3Rlcm5MYW5ndWFnZXMuaW5jbHVkZXModG1kYkl0ZW0ub3JpZ2luYWxfbGFuZ3VhZ2UpKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGDinYwgUVVBTElUWSBHQVRFIFJFSkVDVDogTm9uLXdlc3Rlcm4gbGFuZ3VhZ2UgXCIke3RtZGJJdGVtLm9yaWdpbmFsX2xhbmd1YWdlfVwiIGZvciBpdGVtICR7dG1kYkl0ZW0uaWR9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAoIXRtZGJJdGVtLm92ZXJ2aWV3IHx8IHR5cGVvZiB0bWRiSXRlbS5vdmVydmlldyAhPT0gJ3N0cmluZycgfHwgdG1kYkl0ZW0ub3ZlcnZpZXcudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICBjb25zb2xlLmxvZyhg4p2MIFFVQUxJVFkgR0FURSBSRUpFQ1Q6IEVtcHR5IG92ZXJ2aWV3IGZvciBpdGVtICR7dG1kYkl0ZW0uaWR9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAodG1kYkl0ZW0ub3ZlcnZpZXcuaW5jbHVkZXMoJ0Rlc2NyaXBjacOzbiBubyBkaXNwb25pYmxlJykpIHtcclxuICAgICAgY29uc29sZS5sb2coYOKdjCBRVUFMSVRZIEdBVEUgUkVKRUNUOiBcIkRlc2NyaXBjacOzbiBubyBkaXNwb25pYmxlXCIgZm91bmQgaW4gaXRlbSAke3RtZGJJdGVtLmlkfWApO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIFxyXG4gICAgaWYgKCF0bWRiSXRlbS5wb3N0ZXJfcGF0aCB8fCB0eXBlb2YgdG1kYkl0ZW0ucG9zdGVyX3BhdGggIT09ICdzdHJpbmcnIHx8IHRtZGJJdGVtLnBvc3Rlcl9wYXRoLnRyaW0oKS5sZW5ndGggPT09IDApIHtcclxuICAgICAgY29uc29sZS5sb2coYOKdjCBRVUFMSVRZIEdBVEUgUkVKRUNUOiBNaXNzaW5nIHBvc3Rlcl9wYXRoIGZvciBpdGVtICR7dG1kYkl0ZW0uaWR9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICAvLyBDUklUSUNBTCBCVVNJTkVTUyBMT0dJQzogRGV0ZWN0IG1vdmllcyBpbiBUViByb29tcyAoXCJUaGUgTWF0cml4XCIgRGV0ZWN0aW9uKVxyXG4gICAgaWYgKGV4cGVjdGVkTWVkaWFUeXBlID09PSAnVFYnKSB7XHJcbiAgICAgIGlmICh0bWRiSXRlbS5tZWRpYV90eXBlID09PSAnbW92aWUnKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihg8J+aqCBDUklUSUNBTDogTU9WSUUgREVURUNURUQgaW4gVFYgcm9vbSAtIEl0ZW0gJHt0bWRiSXRlbS5pZH0gKG1lZGlhX3R5cGU6IG1vdmllKWApO1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ1JJVElDQUw6IE1PVklFIERFVEVDVEVEIGluIFRWIHJvb20gLSBJdGVtICR7dG1kYkl0ZW0uaWR9IGhhcyBtZWRpYV90eXBlOiBtb3ZpZWApO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICBpZiAodG1kYkl0ZW0udGl0bGUgJiYgdG1kYkl0ZW0ucmVsZWFzZV9kYXRlICYmICF0bWRiSXRlbS5uYW1lICYmICF0bWRiSXRlbS5maXJzdF9haXJfZGF0ZSkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYPCfmqggQ1JJVElDQUw6IE1PVklFIERFVEVDVEVEIGluIFRWIHJvb20gLSBJdGVtICR7dG1kYkl0ZW0uaWR9IChcIiR7dG1kYkl0ZW0udGl0bGV9XCIpIGhhcyBtb3ZpZSBmaWVsZCBzdHJ1Y3R1cmVgKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENSSVRJQ0FMOiBNT1ZJRSBERVRFQ1RFRCBpbiBUViByb29tIC0gSXRlbSAke3RtZGJJdGVtLmlkfSAoXCIke3RtZGJJdGVtLnRpdGxlfVwiKSBoYXMgbW92aWUgZmllbGRzICh0aXRsZS9yZWxlYXNlX2RhdGUpIGluc3RlYWQgb2YgVFYgZmllbGRzIChuYW1lL2ZpcnN0X2Fpcl9kYXRlKWApO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICBpZiAoIXRtZGJJdGVtLm5hbWUgfHwgIXRtZGJJdGVtLmZpcnN0X2Fpcl9kYXRlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOKdjCBRVUFMSVRZIEdBVEUgUkVKRUNUOiBJdGVtICR7dG1kYkl0ZW0uaWR9IG1pc3NpbmcgVFYgZmllbGRzIChuYW1lL2ZpcnN0X2Fpcl9kYXRlKWApO1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGlmIChleHBlY3RlZE1lZGlhVHlwZSA9PT0gJ01PVklFJykge1xyXG4gICAgICBpZiAodG1kYkl0ZW0ubWVkaWFfdHlwZSA9PT0gJ3R2Jykge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGDinYwgUVVBTElUWSBHQVRFIFJFSkVDVDogVFYgaXRlbSAke3RtZGJJdGVtLmlkfSBpbiBNT1ZJRSByb29tIChtZWRpYV90eXBlKWApO1xyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICBpZiAodG1kYkl0ZW0ubmFtZSAmJiB0bWRiSXRlbS5maXJzdF9haXJfZGF0ZSAmJiAhdG1kYkl0ZW0udGl0bGUgJiYgIXRtZGJJdGVtLnJlbGVhc2VfZGF0ZSkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGDinYwgUVVBTElUWSBHQVRFIFJFSkVDVDogVFYgaXRlbSAke3RtZGJJdGVtLmlkfSAoXCIke3RtZGJJdGVtLm5hbWV9XCIpIGluIE1PVklFIHJvb20gKGZpZWxkIHN0cnVjdHVyZSlgKTtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgaWYgKCF0bWRiSXRlbS50aXRsZSB8fCAhdG1kYkl0ZW0ucmVsZWFzZV9kYXRlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYOKdjCBRVUFMSVRZIEdBVEUgUkVKRUNUOiBJdGVtICR7dG1kYkl0ZW0uaWR9IG1pc3NpbmcgTU9WSUUgZmllbGRzICh0aXRsZS9yZWxlYXNlX2RhdGUpYCk7XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc3QgdGl0bGUgPSBleHBlY3RlZE1lZGlhVHlwZSA9PT0gJ1RWJyA/IHRtZGJJdGVtLm5hbWUhIDogdG1kYkl0ZW0udGl0bGUhO1xyXG4gICAgY29uc3QgcmVsZWFzZURhdGUgPSBleHBlY3RlZE1lZGlhVHlwZSA9PT0gJ1RWJyA/IHRtZGJJdGVtLmZpcnN0X2Fpcl9kYXRlISA6IHRtZGJJdGVtLnJlbGVhc2VfZGF0ZSE7XHJcbiAgICBcclxuICAgIGNvbnN0IHZhbGlkSXRlbTogVmFsaWRhdGVkSXRlbSA9IHtcclxuICAgICAgdG1kYklkOiB0bWRiSXRlbS5pZC50b1N0cmluZygpLFxyXG4gICAgICBtZWRpYVR5cGU6IGV4cGVjdGVkTWVkaWFUeXBlLFxyXG4gICAgICB0aXRsZTogdGl0bGUudHJpbSgpLFxyXG4gICAgICBwb3N0ZXJQYXRoOiBgaHR0cHM6Ly9pbWFnZS50bWRiLm9yZy90L3AvdzUwMCR7dG1kYkl0ZW0ucG9zdGVyX3BhdGh9YCxcclxuICAgICAgb3ZlcnZpZXc6IHRtZGJJdGVtLm92ZXJ2aWV3LnRyaW0oKSxcclxuICAgICAgZ2VucmVJZHM6IHRtZGJJdGVtLmdlbnJlX2lkcyB8fCBbXSxcclxuICAgICAgdm90ZUF2ZXJhZ2U6IHRtZGJJdGVtLnZvdGVfYXZlcmFnZSB8fCAwLFxyXG4gICAgICB2b3RlQ291bnQ6IHRtZGJJdGVtLnZvdGVfY291bnQgfHwgMCxcclxuICAgICAgcG9wdWxhcml0eTogdG1kYkl0ZW0ucG9wdWxhcml0eSB8fCAwLFxyXG4gICAgICByZWxlYXNlRGF0ZSxcclxuICAgICAgcHJpb3JpdHksXHJcbiAgICAgIGFkZGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgfTtcclxuICAgIFxyXG4gICAgY29uc29sZS5sb2coYOKchSBRVUFMSVRZIEdBVEUgUEFTUzogJHtleHBlY3RlZE1lZGlhVHlwZX0gaXRlbSBcIiR7dGl0bGV9XCIgKElEOiAke3RtZGJJdGVtLmlkfSwgTGFuZzogJHt0bWRiSXRlbS5vcmlnaW5hbF9sYW5ndWFnZX0pYCk7XHJcbiAgICByZXR1cm4gdmFsaWRJdGVtO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0QXZhaWxhYmxlR2VucmVzKG1lZGlhVHlwZTogc3RyaW5nKTogUHJvbWlzZTx7IGlkOiBudW1iZXI7IG5hbWU6IHN0cmluZyB9W10+IHtcclxuICAgIGNvbnNvbGUubG9nKGDwn46tIENvbnRlbnRGaWx0ZXJTZXJ2aWNlOiBHZXR0aW5nIGF2YWlsYWJsZSBnZW5yZXMgZm9yICR7bWVkaWFUeXBlfWApO1xyXG4gICAgXHJcbiAgICBjb25zdCBlbmRwb2ludCA9IG1lZGlhVHlwZSA9PT0gJ01PVklFJyA/ICcvZ2VucmUvbW92aWUvbGlzdCcgOiAnL2dlbnJlL3R2L2xpc3QnO1xyXG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5iYXNlVXJsfSR7ZW5kcG9pbnR9YDtcclxuICAgIFxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQodXJsLCB7XHJcbiAgICAgICAgcGFyYW1zOiB7XHJcbiAgICAgICAgICBhcGlfa2V5OiB0aGlzLmFwaUtleSxcclxuICAgICAgICAgIGxhbmd1YWdlOiAnZXMtRVMnXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgXHJcbiAgICAgIHJldHVybiByZXNwb25zZS5kYXRhLmdlbnJlcyB8fCBbXTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoYOKdjCBFcnJvciBnZXR0aW5nIGdlbnJlczpgLCBlcnJvcik7XHJcbiAgICAgIHRocm93IGVycm9yO1xyXG4gICAgfVxyXG4gIH1cclxufSJdfQ==